<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin ‚Äì Benutzer & Queue</title>
<style>
*{box-sizing:border-box} body{margin:0;padding:16px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7f8;color:#111}
.card{max-width:1150px;margin:0 auto;background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#f0f0f0;border:1px solid #e5e5e5;white-space:nowrap}
button{padding:10px 12px;border:0;border-radius:10px;background:#111;color:#fff;cursor:pointer}
button.secondary{background:#444} button.danger{background:#b91c1c} button.ok{background:#15803d}
button:disabled{opacity:.5;cursor:not-allowed}
input,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;background:#fff}
.hint{font-size:12px;color:#666;margin-top:6px}
.divider{height:1px;background:#eee;margin:14px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.hidden{display:none}
.loginWrap{max-width:460px;margin:0 auto}
.loginCard{background:#fff;border-radius:12px;padding:26px;border:1px solid #e2e8f0;box-shadow:0 4px 6px -1px rgba(0,0,0,.10)}
.loginHeader{text-align:center;margin-bottom:18px}
.loginHeader h2{margin:0 0 6px;font-size:1.6rem;font-weight:800;color:#1e293b}
.loginHeader p{margin:0;color:#64748b;font-size:.9rem}
.form-group{margin-bottom:16px}
.input-wrapper{position:relative}
.input-wrapper input{border:2px solid #e2e8f0;border-radius:8px;padding:20px 16px 10px;font-size:16px;outline:none;transition:.2s;width:100%}
.input-wrapper label{position:absolute;left:16px;top:14px;color:#64748b;font-size:14px;transition:.2s;pointer-events:none}
.input-wrapper input:focus,.input-wrapper input:valid,.input-wrapper input.has-value{border-color:#6366f1}
.input-wrapper input:focus+label,.input-wrapper input:valid+label,.input-wrapper input.has-value+label{transform:translateY(-8px) scale(.9);color:#6366f1;font-weight:700}
.error{color:#ef4444;font-size:.78rem;font-weight:600;margin:6px 0 0 4px;min-height:1em}
.login-btn{width:100%;background:#6366f1;border:0;border-radius:8px;padding:12px 24px;color:#fff;font-size:16px;font-weight:800}
table{width:100%;border-collapse:collapse;border:1px solid #eee;border-radius:12px;overflow:hidden}
thead th{font-size:12px;color:#444;background:#f7f7f7;border-bottom:1px solid #eee;padding:10px;white-space:nowrap;text-align:left}
tbody td{padding:10px;border-bottom:1px solid #f0f0f0;font-size:14px;vertical-align:top}
.tag{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #e5e5e5;background:#f3f3f3;white-space:nowrap}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.actions{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="card">
  <div class="topbar">
    <h1 id="title">Admin ‚Äì Benutzer & Queue</h1>
    <div class="right">
      <span class="pill" id="userPill">‚Äî</span>
      <label class="pill" title="Sound an/aus" style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="soundToggle" checked>
        <span>üîä</span>
      </label>
      <select id="langSelect" style="width:auto;min-width:140px">
        <option value="de">Deutsch</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      </select>
    </div>
  </div>

  <div id="loginBox" class="loginWrap">
    <div class="loginCard">
      <div class="loginHeader">
        <h2 id="loginH2">Anmelden</h2>
        <p id="loginP">Admin-Benutzername und PIN eingeben</p>
      </div>
      <form id="loginForm" novalidate>
        <div class="form-group">
          <div class="input-wrapper">
            <input id="loginUser" type="text" required autocomplete="username">
            <label for="loginUser" id="loginUserLabel">Benutzername</label>
          </div>
          <div class="error" id="userError"></div>
        </div>
        <div class="form-group">
          <div class="input-wrapper">
            <input id="loginPin" type="password" required inputmode="numeric" autocomplete="current-password">
            <label for="loginPin" id="loginPinLabel">PIN</label>
          </div>
          <div class="error" id="pinError"></div>
        </div>
        <button class="login-btn" type="submit" id="btnLogin"><span id="btnLoginText">Einloggen</span></button>
        <div class="hint" id="loginHint">Nur ADMIN darf diese Seite benutzen.</div>
      </form>
    </div>
    <div class="divider"></div>
  </div>

  <div id="appBox" class="hidden">
    <div class="row">
      <button id="btnRefreshUsers">üë• User Refresh</button>
      <button id="btnRefreshQueue" class="secondary">üè∑Ô∏è Queue Refresh</button>
      <button id="btnLogout" class="secondary">Logout</button>
    </div>

    <div class="divider"></div>

    <div class="grid">
      <div>
        <div class="hint" style="font-weight:700" id="usersTitle">Benutzer</div>
        <div class="hint" id="usersHint">Hier kannst du Mitarbeiter anlegen, PIN √§ndern und l√∂schen.</div>

        <div class="row">
          <div style="flex:1 1 220px"><input id="newUser" type="text" placeholder="Neuer Benutzername"></div>
          <div style="flex:1 1 160px"><input id="newPin" type="password" inputmode="numeric" placeholder="PIN"></div>
          <div style="flex:1 1 200px">
            <select id="newRole">
              <option value="staff">staff</option>
              <option value="office">office</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <button id="btnCreateUser" class="ok">‚ûï Anlegen</button>
        </div>
        <div class="hint" id="createHint"></div>

        <div class="divider"></div>

        <div style="overflow:auto">
          <table>
            <thead><tr>
              <th id="thUser">User</th><th id="thRole">Role</th><th id="thPin">PIN</th><th id="thUserActions">Aktionen</th>
            </tr></thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>
        <div class="hint" id="usersFootHint"></div>
      </div>

      <div>
        <div class="hint" style="font-weight:700" id="queueTitle">Etikett Queue</div>
        <div class="hint" id="queueHint">Admin kann die Queue ansehen und Eintr√§ge l√∂schen.</div>

        <div class="row">
          <label class="pill" style="display:flex;align-items:center;gap:8px" title="Nur neue anzeigen">
            <input type="checkbox" id="onlyNew" checked>
            <span id="onlyNewLabel">nur NEU</span>
          </label>
          <button id="btnClearDone" class="danger">üßπ DONE l√∂schen</button>
        </div>

        <div class="divider"></div>

        <div style="overflow:auto">
          <table>
            <thead><tr>
              <th id="qTime">Zeit</th><th id="qStatus">Status</th><th id="qEAN">EAN</th><th id="qSize">Etikett</th><th id="qBy">Von</th><th id="qActions">Aktionen</th>
            </tr></thead>
            <tbody id="queueTbody"></tbody>
          </table>
        </div>
        <div class="hint" id="queueFootHint"></div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ‚úÖ DEINE Google Apps Script WebApp URL
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzKFVuk3W6sNGPvSVqOsXxwqfzOGq8H36nx5aA2B_JaHtLQzpoKwcgfr53-BiTFL35B/exec";

  const $ = (id)=>document.getElementById(id);
  const digitsOnly = (s)=>String(s??"").replace(/\D/g,"");
  const esc = (s)=>String(s??"").replace(/[&<>'"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","'":"&#039;",'"':"&quot;" }[m]));

  // ===== i18n =====
  const I18N = {
    de: {
      title:"Admin ‚Äì Benutzer & Queue",
      loginH2:"Anmelden",
      loginP:"Admin-Benutzername und PIN eingeben",
      userLabel:"Benutzername",
      pinLabel:"PIN",
      loginBtn:"Einloggen",
      loginHint:"Nur ADMIN darf diese Seite benutzen.",
      badUser:"Bitte Benutzername eingeben.",
      badPin:"PIN mindestens 4 Ziffern.",
      badCred:"Falscher Benutzername oder PIN.",
      notAdmin:"Kein Zugriff (nur Admin).",

      usersTitle:"Benutzer",
      usersHint:"Hier kannst du Mitarbeiter anlegen, PIN √§ndern und l√∂schen.",
      newUserPh:"Neuer Benutzername",
      pinPh:"PIN",
      createBtn:"‚ûï Anlegen",
      thUser:"User",
      thRole:"Role",
      thPin:"PIN",
      thUserActions:"Aktionen",
      btnSetPin:"üîë PIN √§ndern",
      btnDelete:"üóë L√∂schen",
      createdOk:"Benutzer erstellt ‚úÖ",
      pinChanged:"PIN ge√§ndert ‚úÖ",
      deletedOk:"Gel√∂scht ‚úÖ",
      failed:"Fehler",

      queueTitle:"Etikett Queue",
      queueHint:"Admin kann die Queue ansehen und Eintr√§ge l√∂schen.",
      onlyNew:"nur NEU",
      clearDone:"üßπ DONE l√∂schen",
      qTime:"Zeit",
      qStatus:"Status",
      qEAN:"EAN",
      qSize:"Etikett",
      qBy:"Von",
      qActions:"Aktionen",
      qDelete:"üóë L√∂schen",
      empty:"Keine Eintr√§ge.",
      loading:"Lade‚Ä¶",

      sizeName:(v)=>{
        if(v==="80x39") return "Regaletikett";
        if(v==="35x70") return "K√ºhlwaren Etikett";
        if(v==="50x25") return "Kleinetikett";
        return v || "-";
      },
      statusName:(s)=>{
        s=String(s||"").toUpperCase();
        if(s==="NEW") return "NEU";
        if(s==="DONE") return "ERLEDIGT";
        return s || "-";
      }
    },
    ru: {
      title:"–ê–¥–º–∏–Ω ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –æ—á–µ—Ä–µ–¥—å",
      loginH2:"–í—Ö–æ–¥",
      loginP:"–í–≤–µ–¥–∏—Ç–µ admin –∏ PIN",
      userLabel:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
      pinLabel:"PIN",
      loginBtn:"–í–æ–π—Ç–∏",
      loginHint:"–¢–æ–ª—å–∫–æ ADMIN –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É.",
      badUser:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
      badPin:"PIN –º–∏–Ω–∏–º—É–º 4 —Ü–∏—Ñ—Ä—ã.",
      badCred:"–ù–µ–≤–µ—Ä–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ PIN.",
      notAdmin:"–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ (—Ç–æ–ª—å–∫–æ admin).",

      usersTitle:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
      usersHint:"–ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –º–µ–Ω—è—Ç—å PIN –∏ —É–¥–∞–ª—è—Ç—å.",
      newUserPh:"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
      pinPh:"PIN",
      createBtn:"‚ûï –°–æ–∑–¥–∞—Ç—å",
      thUser:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
      thRole:"–†–æ–ª—å",
      thPin:"PIN",
      thUserActions:"–î–µ–π—Å—Ç–≤–∏—è",
      btnSetPin:"üîë –ò–∑–º–µ–Ω–∏—Ç—å PIN",
      btnDelete:"üóë –£–¥–∞–ª–∏—Ç—å",
      createdOk:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω ‚úÖ",
      pinChanged:"PIN –∏–∑–º–µ–Ω—ë–Ω ‚úÖ",
      deletedOk:"–£–¥–∞–ª–µ–Ω–æ ‚úÖ",
      failed:"–û—à–∏–±–∫–∞",

      queueTitle:"–û—á–µ—Ä–µ–¥—å —ç—Ç–∏–∫–µ—Ç–æ–∫",
      queueHint:"–ê–¥–º–∏–Ω –º–æ–∂–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å –æ—á–µ—Ä–µ–¥—å –∏ —É–¥–∞–ª—è—Ç—å –∑–∞–ø–∏—Å–∏.",
      onlyNew:"—Ç–æ–ª—å–∫–æ –ù–û–í–´–ï",
      clearDone:"üßπ —É–¥–∞–ª–∏—Ç—å DONE",
      qTime:"–í—Ä–µ–º—è",
      qStatus:"–°—Ç–∞—Ç—É—Å",
      qEAN:"EAN",
      qSize:"–≠—Ç–∏–∫–µ—Ç–∫–∞",
      qBy:"–û—Ç",
      qActions:"–î–µ–π—Å—Ç–≤–∏—è",
      qDelete:"üóë –£–¥–∞–ª–∏—Ç—å",
      empty:"–ü—É—Å—Ç–æ.",
      loading:"–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶",

      sizeName:(v)=>{
        if(v==="80x39") return "–ü–æ–ª–æ—á–Ω–∞—è —ç—Ç–∏–∫–µ—Ç–∫–∞";
        if(v==="35x70") return "–≠—Ç–∏–∫–µ—Ç–∫–∞ –¥–ª—è —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞";
        if(v==="50x25") return "–ú–∞–ª–µ–Ω—å–∫–∞—è —ç—Ç–∏–∫–µ—Ç–∫–∞";
        return v || "-";
      },
      statusName:(s)=>{
        s=String(s||"").toUpperCase();
        if(s==="NEW") return "–ù–û–í–û–ï";
        if(s==="DONE") return "–ì–û–¢–û–í–û";
        return s || "-";
      }
    }
  };

  let lang = localStorage.getItem("lang_admin") || localStorage.getItem("lang") || "de";
  function t(key,arg){
    const d=I18N[lang]||I18N.de;
    const v=d[key];
    return (typeof v==="function") ? v(arg) : v;
  }
  function applyLang(){
    $("title").textContent=t("title");
    $("loginH2").textContent=t("loginH2");
    $("loginP").textContent=t("loginP");
    $("loginUserLabel").textContent=t("userLabel");
    $("loginPinLabel").textContent=t("pinLabel");
    $("btnLoginText").textContent=t("loginBtn");
    $("loginHint").textContent=t("loginHint");

    $("usersTitle").textContent=t("usersTitle");
    $("usersHint").textContent=t("usersHint");
    $("newUser").placeholder=t("newUserPh");
    $("newPin").placeholder=t("pinPh");
    $("btnCreateUser").textContent=t("createBtn");

    $("thUser").textContent=t("thUser");
    $("thRole").textContent=t("thRole");
    $("thPin").textContent=t("thPin");
    $("thUserActions").textContent=t("thUserActions");

    $("queueTitle").textContent=t("queueTitle");
    $("queueHint").textContent=t("queueHint");
    $("onlyNewLabel").textContent=t("onlyNew");
    $("btnClearDone").textContent=t("clearDone");

    $("qTime").textContent=t("qTime");
    $("qStatus").textContent=t("qStatus");
    $("qEAN").textContent=t("qEAN");
    $("qSize").textContent=t("qSize");
    $("qBy").textContent=t("qBy");
    $("qActions").textContent=t("qActions");
  }

  $("langSelect").value=lang;
  $("langSelect").addEventListener("change",(e)=>{
    lang=e.target.value;
    localStorage.setItem("lang_admin", lang);
    applyLang();
    renderUsers(lastUsers);
    renderQueue(lastQueue);
  });

  // ===== sound =====
  let audioCtx=null;
  function soundEnabled(){ return $("soundToggle")?.checked; }
  async function ensureAudio(){
    if(!soundEnabled()) return null;
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state==="suspended"){ try{ await audioCtx.resume(); } catch {} }
    return audioCtx;
  }
  function beep(freq=880,ms=120,type="sine",gainVal=0.08){
    if(!soundEnabled()) return;
    ensureAudio().then((ctx)=>{
      if(!ctx) return;
      const t0=ctx.currentTime;
      const osc=ctx.createOscillator(); osc.type=type; osc.frequency.setValueAtTime(freq,t0);
      const gain=ctx.createGain();
      gain.gain.setValueAtTime(0.0001,t0);
      gain.gain.exponentialRampToValueAtTime(gainVal,t0+0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001,t0+ms/1000);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t0); osc.stop(t0+ms/1000+0.02);
    });
  }
  function successSound(){ beep(880,110,"sine",0.08); setTimeout(()=>beep(1320,90,"sine",0.06),120); }
  function errorSound(){ beep(220,160,"square",0.06); setTimeout(()=>beep(180,160,"square",0.05),170); }

  $("soundToggle").checked = (localStorage.getItem("sound_admin") ?? localStorage.getItem("sound") ?? "1") === "1";
  $("soundToggle").addEventListener("change", ()=>{
    localStorage.setItem("sound_admin", $("soundToggle").checked ? "1" : "0");
    if($("soundToggle").checked) ensureAudio();
  });

  // ===== float labels =====
  function bindFloatLabel(inputId){
    const inp=$(inputId);
    const update=()=>{ inp.value?.trim()?inp.classList.add("has-value"):inp.classList.remove("has-value"); };
    inp.addEventListener("input",update); inp.addEventListener("blur",update);
    setTimeout(update,0); setTimeout(update,150);
  }
  bindFloatLabel("loginUser"); bindFloatLabel("loginPin");

  // ===== state =====
  let token = localStorage.getItem("token_admin") || "";
  let username = localStorage.getItem("user_admin") || "";
  let userRole = localStorage.getItem("role_admin") || "";

  function setLoginUI(on){
    $("loginBox").classList.toggle("hidden", on);
    $("appBox").classList.toggle("hidden", !on);
    $("userPill").textContent = on ? `${username} (${userRole})` : "‚Äî";
  }

  function isAdmin(role){
    return String(role||"").toLowerCase()==="admin";
  }

  // ===== API =====
  async function apiPost(payload){
    const res = await fetch(WEBAPP_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function tryActions(actionNames, payloadBuilder){
    let lastErr=null;
    for(const action of actionNames){
      try{
        const data = await apiPost(payloadBuilder(action));
        if(data && (data.ok===true || data.success===true)) return data;
        lastErr = data?.error || data?.message || JSON.stringify(data);
      }catch(e){
        lastErr = String(e);
      }
    }
    throw new Error(lastErr || "unknown_error");
  }

  function setLoadingLogin(on){
    $("btnLogin").disabled = !!on;
  }

  async function login(){
    await ensureAudio();
    $("userError").textContent=""; $("pinError").textContent="";

    const u=String($("loginUser").value||"").trim();
    const p=digitsOnly($("loginPin").value||"");

    if(!u){ $("userError").textContent = t("badUser"); errorSound(); return; }
    if(p.length<4){ $("pinError").textContent = t("badPin"); errorSound(); return; }

    setLoadingLogin(true);
    try{
      const data = await tryActions(
        ["auth_login","login","auth","user_login","pin_login"],
        (action)=>({ action, username:u, user:u, login:u, pin:p, password:p })
      );

      const tok = data.token || data.session || data.sessionToken || data.authToken || "";
      const usrObj = data.user || data.account || {};
      const role = (usrObj.role || data.role || data.userRole || "staff");
      const uname = (usrObj.username || usrObj.name || data.username || u);

      if(!isAdmin(role)){
        $("pinError").textContent = t("notAdmin");
        errorSound();
        return;
      }

      token = tok || "NO_TOKEN";
      username = uname;
      userRole = role;

      localStorage.setItem("token_admin", token);
      localStorage.setItem("user_admin", username);
      localStorage.setItem("role_admin", userRole);

      successSound();
      setLoginUI(true);
      await refreshUsers();
      await refreshQueue();
    }catch(e){
      $("pinError").textContent = t("badCred");
      errorSound();
    }finally{
      setLoadingLogin(false);
    }
  }

  $("loginForm").addEventListener("submit",(e)=>{ e.preventDefault(); login(); });

  function logout(){
    token=""; username=""; userRole="";
    localStorage.removeItem("token_admin");
    localStorage.removeItem("user_admin");
    localStorage.removeItem("role_admin");
    setLoginUI(false);
  }
  $("btnLogout").addEventListener("click", logout);

  // ===== Users =====
  let lastUsers = [];

  function renderUsers(users){
    lastUsers = Array.isArray(users) ? users : [];
    const tb = $("usersTbody");
    tb.innerHTML = "";

    if(lastUsers.length===0){
      tb.innerHTML = `<tr><td colspan="4" style="padding:16px">${esc(t("empty"))}</td></tr>`;
      return;
    }

    for(const u of lastUsers){
      const id = u.id ?? u.userId ?? u._id ?? u.username ?? "";
      const uname = u.username ?? u.user ?? "";
      const role = u.role ?? "staff";
      const pin  = u.pin ?? u.PIN ?? "";

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><strong>${esc(uname)}</strong></td>
        <td><span class="tag">${esc(role)}</span></td>
        <td class="mono">${esc(pin ? String(pin) : "-")}</td>
        <td>
          <div class="actions">
            <button class="secondary" data-act="setpin" data-id="${esc(id)}" data-user="${esc(uname)}">${esc(t("btnSetPin"))}</button>
            <button class="danger" data-act="del" data-id="${esc(id)}" data-user="${esc(uname)}">${esc(t("btnDelete"))}</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    }

    tb.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const act = btn.getAttribute("data-act");
        const id = btn.getAttribute("data-id");
        const uname = btn.getAttribute("data-user");
        if(!id) return;

        btn.disabled=true;
        try{
          if(act==="setpin"){
            const newPin = prompt("Neue PIN f√ºr " + uname + ":", "");
            if(!newPin){ btn.disabled=false; return; }
            const p = digitsOnly(newPin);
            if(p.length<4){ alert(t("badPin")); throw new Error("bad_pin"); }
            await tryActions(
              ["users_update_pin","user_update_pin","set_pin","update_pin","accounts_update"],
              (action)=>({ action, token, id, username:uname, user:uname, pin:p, password:p })
            );
            alert(t("pinChanged"));
          }else if(act==="del"){
            if(!confirm("L√∂schen: " + uname + " ?")){ btn.disabled=false; return; }
            await tryActions(
              ["users_delete","user_delete","delete_user","remove_user","accounts_delete"],
              (action)=>({ action, token, id, username:uname, user:uname })
            );
            alert(t("deletedOk"));
          }
          await refreshUsers();
          successSound();
        }catch(e){
          alert(t("failed") + ": " + String(e||""));
          errorSound();
        }finally{
          btn.disabled=false;
        }
      });
    });
  }

  async function refreshUsers(){
    $("usersFootHint").textContent = t("loading");
    try{
      const data = await tryActions(
        ["users_list","user_list","list_users","get_users","accounts_list"],
        (action)=>({ action, token })
      );
      const users = data.users || data.rows || data.data || data.items || [];
      renderUsers(users);
      $("usersFootHint").textContent = "";
    }catch(e){
      $("usersFootHint").textContent = t("failed") + ": " + String(e||"");
    }
  }

  $("btnRefreshUsers").addEventListener("click", refreshUsers);

  $("btnCreateUser").addEventListener("click", async ()=>{
    const u = String($("newUser").value||"").trim();
    const p = digitsOnly($("newPin").value||"");
    const r = String($("newRole").value||"staff");

    if(!u){ $("createHint").textContent = t("badUser"); errorSound(); return; }
    if(p.length<4){ $("createHint").textContent = t("badPin"); errorSound(); return; }

    $("btnCreateUser").disabled=true;
    $("createHint").textContent = t("loading");
    try{
      await tryActions(
        ["users_create","user_create","create_user","add_user","accounts_create"],
        (action)=>({ action, token, username:u, user:u, pin:p, password:p, role:r })
      );
      $("createHint").textContent = t("createdOk");
      $("newUser").value=""; $("newPin").value="";
      await refreshUsers();
      successSound();
    }catch(e){
      $("createHint").textContent = t("failed") + ": " + String(e||"");
      errorSound();
    }finally{
      $("btnCreateUser").disabled=false;
    }
  });

  // ===== Queue =====
  let lastQueue = [];

  function fmtTime(ts){
    if(!ts) return "-";
    const d=new Date(ts);
    if(isNaN(d.getTime())) return String(ts);
    return d.toLocaleString();
  }

  function renderQueue(rows){
    lastQueue = Array.isArray(rows) ? rows : [];
    const onlyNew = $("onlyNew").checked;
    const filtered = onlyNew ? lastQueue.filter(r=>String(r.status||"").toUpperCase()==="NEW") : lastQueue;

    const tb=$("queueTbody");
    tb.innerHTML="";

    if(filtered.length===0){
      tb.innerHTML = `<tr><td colspan="6" style="padding:16px">${esc(t("empty"))}</td></tr>`;
      return;
    }

    for(const r of filtered){
      const id = r.id ?? r.rowId ?? r._id ?? "";
      const ean = r.ean || r.barcode || "";
      const size = r.size || r.labelSize || "";
      const by = r.note || r.user || r.by || "";
      const ts = r.timestamp || r.time || r.created || "";
      const status = String(r.status||"").toUpperCase();

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(fmtTime(ts))}</td>
        <td><span class="tag">${esc(t("statusName", status))}</span></td>
        <td class="mono">${esc(ean)}</td>
        <td><span class="tag">${esc(t("sizeName", size))}</span></td>
        <td>${esc(by || "-")}</td>
        <td>
          <div class="actions">
            <button class="danger" data-act="qdel" data-id="${esc(id)}">${esc(t("qDelete"))}</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    }

    tb.querySelectorAll("button[data-act='qdel']").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        if(!id) return;
        if(!confirm("Queue-Eintrag l√∂schen?")) return;

        btn.disabled=true;
        try{
          await tryActions(
            ["queue_delete","delete","remove","queue_remove","sheet_delete"],
            (action)=>({ action, token, id })
          );
          await refreshQueue();
          successSound();
        }catch(e){
          alert(t("failed") + ": " + String(e||""));
          errorSound();
        }finally{
          btn.disabled=false;
        }
      });
    });
  }

  async function refreshQueue(){
    $("queueFootHint").textContent=t("loading");
    try{
      const onlyNew = $("onlyNew").checked ? "1" : "0";
      const data = await tryActions(
        ["queue_list","list","get","queue_get","sheet_list"],
        (action)=>({ action, token, onlyNew })
      );
      const rows = data.rows || data.data || data.items || [];
      renderQueue(rows);
      $("queueFootHint").textContent="";
    }catch(e){
      $("queueFootHint").textContent=t("failed") + ": " + String(e||"");
    }
  }

  async function clearDone(){
    try{
      await tryActions(
        ["queue_clear_done","clear_done","queue_delete_done"],
        (action)=>({ action, token })
      );
    }catch{
      const doneRows = lastQueue.filter(r=>String(r.status||"").toUpperCase()==="DONE");
      for(const r of doneRows){
        const id = r.id ?? r.rowId ?? r._id ?? "";
        if(id){
          await tryActions(
            ["queue_delete","delete","remove","queue_remove","sheet_delete"],
            (action)=>({ action, token, id })
          );
        }
      }
    }
  }

  $("btnRefreshQueue").addEventListener("click", refreshQueue);
  $("onlyNew").addEventListener("change", ()=>renderQueue(lastQueue));

  $("btnClearDone").addEventListener("click", async ()=>{
    if(!confirm("DONE Eintr√§ge l√∂schen?")) return;
    $("btnClearDone").disabled=true;
    try{
      await clearDone();
      await refreshQueue();
      successSound();
    }catch(e){
      alert(t("failed") + ": " + String(e||""));
      errorSound();
    }finally{
      $("btnClearDone").disabled=false;
    }
  });

  // ===== init =====
  applyLang();

  if(token && isAdmin(userRole)){
    setLoginUI(true);
    refreshUsers();
    refreshQueue();
  }else{
    setLoginUI(false);
  }
})();
</script>
</body>
</html>
