<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Produkt-Suche (CSV + EAN-Scan)</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/zxing-browser.min.js"></script>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background: #f6f7f8; color: #111; }
    .card { max-width: 820px; margin: 0 auto; background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.08); }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    h1 { font-size: 18px; margin: 0; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 12px; }
    input[type="file"], input[type="text"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; background: #fff; }
    button { padding: 12px 14px; border: 0; border-radius: 10px; background: #111; color: #fff; cursor: pointer; }
    button.secondary { background: #444; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .hint { font-size: 12px; color: #666; margin-top: 6px; }
    .result { margin-top: 14px; padding: 14px; border-radius: 12px; border: 1px solid #e6e6e6; background: #fafafa; }
    .status { font-size: 34px; line-height: 1; margin-bottom: 10px; }
    .ok { border-color: #bfe8c9; background: #f0fbf3; }
    .bad { border-color: #f0b8b8; background: #fff1f1; }
    .kv { display: grid; grid-template-columns: 120px 1fr; gap: 6px 10px; font-size: 14px; }
    .kv div { padding: 2px 0; }
    .label { color: #555; }
    .videoWrap { margin-top: 12px; display: none; }
    video { width: 100%; border-radius: 12px; background: #000; }
    .small { font-size: 12px; color: #666; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .pill { font-size:12px; padding:6px 10px; border-radius:999px; background:#f0f0f0; border:1px solid #e5e5e5; }
    .right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .toggle { display:flex; align-items:center; gap:8px; }
  </style>
</head>

<body>
  <div class="card">
    <div class="topbar">
      <h1 id="title">Produkt-Suche (CSV + EAN Scan)</h1>
      <div class="right">
        <span class="pill" id="dbStatus">DB: ‚Äì</span>

        <label class="pill toggle" title="Sound an/aus">
          <input type="checkbox" id="soundToggle" checked />
          <span id="soundLbl">üîä</span>
        </label>

        <select id="langSelect" style="width:auto; min-width:140px;">
          <option value="de">Deutsch</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div style="flex: 1 1 360px;">
        <input id="csvFile" type="file" accept=".csv,text/csv" />
        <div class="hint" id="csvHint">CSV muss Spalten haben: <span class="mono">Artikel</span>, <span class="mono">VK-Preis</span>, <span class="mono">EAN</span></div>
      </div>
    </div>

    <div class="row">
      <div style="flex: 1 1 360px;">
        <input id="searchInput" type="text" placeholder="Suchen nach Produktname oder EAN ‚Ä¶" disabled />
        <div class="hint" id="searchHint">Tipp: Du kannst auch nur einen Teil tippen (z. B. ‚Äûmilch‚Äú oder ‚Äû400123‚Äú).</div>
      </div>

      <button id="btnScan" disabled>üì∑ EAN scannen</button>
      <button id="btnStop" class="secondary" disabled>‚èπ Stop</button>
    </div>

    <div class="row">
      <div style="flex: 1 1 220px;">
        <select id="sizeSelect" disabled>
          <!-- Gr√∂√üen aus deinem Etikettenprogramm -->
          <option value="80x39">80√ó39</option>
          <option value="50x25">50√ó25</option>
          <option value="35x70">35√ó70</option>
        </select>
        <div class="hint" id="sizeHint">Etikettgr√∂√üe w√§hlen</div>
      </div>

      <button id="btnSendOffice" disabled>üè∑Ô∏è Etikett ans B√ºro senden</button>
    </div>

    <div class="videoWrap" id="videoWrap">
      <div class="hint" id="scanHint">Kamera l√§uft ‚Äì halte den Barcode ruhig ins Bild.</div>
      <video id="video" playsinline></video>
      <div class="small" id="scanTip">Wenn es nicht scannt: mehr Licht, n√§her ran, ruhiger halten.</div>
    </div>

    <div class="result" id="resultBox">
      <div class="status" id="statusEmoji">üì¶</div>
      <div id="resultText" class="hint">Bitte CSV laden ‚Ä¶</div>
    </div>
  </div>

<script>
(() => {
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycby5tP2hon2uEv9KJEAy5zcnXVZSJj63yuYduI0UdKiJPaZAfhkID_pZSZrFyxWMNXka/exec";

  const I18N = {
    de: {
      title: "Produkt-Suche (CSV + EAN Scan)",
      csvHint: "CSV muss Spalten haben: Artikel, VK-Preis, EAN",
      searchPh: "Suchen nach Produktname oder EAN ‚Ä¶",
      searchHint: "Tipp: Du kannst auch nur einen Teil tippen (z. B. ‚Äûmilch‚Äú oder ‚Äû400123‚Äú).",
      scanBtn: "üì∑ EAN scannen",
      stopBtn: "‚èπ Stop",
      sizeHint: "Etikettgr√∂√üe w√§hlen",
      sendBtn: "üè∑Ô∏è Etikett ans B√ºro senden",
      scanHint: "Kamera l√§uft ‚Äì halte den Barcode ruhig ins Bild.",
      scanTip: "Wenn es nicht scannt: mehr Licht, n√§her ran, ruhiger halten.",
      loadingCsv: "CSV wird geladen ‚Ä¶",
      loadedCsv: (n) => `CSV geladen: ${n} Zeilen. Jetzt suchen oder scannen.`,
      notLoaded: "Bitte CSV laden ‚Ä¶",
      sentOk: "Gesendet ‚úÖ",
      sentFail: "Fehler beim Senden ‚ùå",
      noFound: "Kein Produkt gefunden.",
      db: (n) => `DB: ${n}`
    },
    ru: {
      title: "–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ (CSV + —Å–∫–∞–Ω EAN)",
      csvHint: "CSV –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –∫–æ–ª–æ–Ω–∫–∏: Artikel, VK-Preis, EAN",
      searchPh: "–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ EAN ‚Ä¶",
      searchHint: "–°–æ–≤–µ—Ç: –º–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å —á–∞—Å—Ç—å —Å–ª–æ–≤–∞ –∏–ª–∏ —á–∞—Å—Ç—å EAN.",
      scanBtn: "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å EAN",
      stopBtn: "‚èπ –°—Ç–æ–ø",
      sizeHint: "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä —ç—Ç–∏–∫–µ—Ç–∫–∏",
      sendBtn: "üè∑Ô∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ—Ñ–∏—Å",
      scanHint: "–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞ ‚Äî –¥–µ—Ä–∂–∏—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Ä–æ–≤–Ω–æ –≤ –∫–∞–¥—Ä–µ.",
      scanTip: "–ï—Å–ª–∏ –Ω–µ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç: –±–æ–ª—å—à–µ —Å–≤–µ—Ç–∞, –±–ª–∏–∂–µ, –¥–µ—Ä–∂–∏—Ç–µ —Ä–æ–≤–Ω–µ–µ.",
      loadingCsv: "–ó–∞–≥—Ä—É–∑–∫–∞ CSV ‚Ä¶",
      loadedCsv: (n) => `CSV –∑–∞–≥—Ä—É–∂–µ–Ω: —Å—Ç—Ä–æ–∫ ${n}. –ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –∏–ª–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å.`,
      notLoaded: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ CSV ‚Ä¶",
      sentOk: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ",
      sentFail: "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ‚ùå",
      noFound: "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.",
      db: (n) => `–ë–î: ${n}`
    }
  };

  let lang = localStorage.getItem("lang") || "de";
  let rows = [];
  let indexByEAN = new Map();
  let scanner = null;
  let scanning = false;
  let lastFound = null;

  const $ = (id) => document.getElementById(id);
  const digitsOnly = (s) => String(s ?? "").replace(/\D/g, "");

  /** -------- Sound Engine (no files needed) -------- */
  let audioCtx = null;
  function soundEnabled() { return $("soundToggle")?.checked; }

  async function ensureAudio() {
    if (!soundEnabled()) return null;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") {
      try { await audioCtx.resume(); } catch {}
    }
    return audioCtx;
  }

  function beep(freq = 880, ms = 120, type = "sine", gainVal = 0.08) {
    if (!soundEnabled()) return;
    ensureAudio().then((ctx) => {
      if (!ctx) return;
      const t0 = ctx.currentTime;

      const osc = ctx.createOscillator();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, t0);

      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0.0001, t0);
      gain.gain.exponentialRampToValueAtTime(gainVal, t0 + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, t0 + ms / 1000);

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start(t0);
      osc.stop(t0 + ms / 1000 + 0.02);
    });
  }

  function successSound() { beep(880, 110, "sine", 0.09); setTimeout(() => beep(1320, 90, "sine", 0.07), 120); }
  function errorSound()   { beep(220, 160, "square", 0.06); setTimeout(() => beep(180, 160, "square", 0.05), 170); }
  function sendSound()    { beep(660, 90, "triangle", 0.07); setTimeout(() => beep(990, 70, "triangle", 0.06), 100); }

  function vibrate(pattern = [40, 20, 40]) {
    try { if (navigator.vibrate) navigator.vibrate(pattern); } catch {}
  }

  // Persist sound setting
  $("soundToggle").checked = (localStorage.getItem("sound") ?? "1") === "1";
  $("soundToggle").addEventListener("change", () => {
    localStorage.setItem("sound", $("soundToggle").checked ? "1" : "0");
    // touch audio context (some browsers need it)
    if ($("soundToggle").checked) ensureAudio();
  });

  /** -------- i18n helpers -------- */
  function t(key, arg) {
    const dict = I18N[lang] || I18N.de;
    const val = dict[key];
    return (typeof val === "function") ? val(arg) : val;
  }

  function applyLang() {
    $("title").textContent = t("title");
    $("csvHint").textContent = t("csvHint");
    $("searchInput").placeholder = t("searchPh");
    $("searchHint").textContent = t("searchHint");
    $("btnScan").textContent = t("scanBtn");
    $("btnStop").textContent = t("stopBtn");
    $("sizeHint").textContent = t("sizeHint");
    $("btnSendOffice").textContent = t("sendBtn");
    $("scanHint").textContent = t("scanHint");
    $("scanTip").textContent = t("scanTip");
    $("dbStatus").textContent = t("db", rows.length || "‚Äì");
    if (!rows.length) $("resultText").textContent = t("notLoaded");
  }

  function normalizeRow(r) {
    const artikel = (r["Artikel"] ?? r["artikel"] ?? r["Product"] ?? r["Produkt"] ?? "").toString().trim();
    const preis   = (r["VK-Preis"] ?? r["VK Preis"] ?? r["Preis"] ?? r["price"] ?? "").toString().trim();
    const eanRaw  = (r["EAN"] ?? r["ean"] ?? r["Barcode"] ?? "").toString().trim();
    const ean     = digitsOnly(eanRaw);
    return { artikel, preis, ean };
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function setNotLoaded() {
    $("resultBox").classList.remove("ok", "bad");
    $("statusEmoji").textContent = "üì¶";
    $("resultText").textContent = t("notLoaded");
    lastFound = null;
    $("btnSendOffice").disabled = true;
    $("sizeSelect").disabled = true;
  }

  function setFound(row, playSound = true) {
    $("resultBox").classList.remove("bad");
    $("resultBox").classList.add("ok");
    $("statusEmoji").textContent = "‚úÖ";

    lastFound = row;
    $("btnSendOffice").disabled = false;
    $("sizeSelect").disabled = false;

    const priceText = row.preis ? row.preis : "-";
    $("resultText").innerHTML = `
      <div class="kv">
        <div class="label">${lang === "ru" ? "–¢–æ–≤–∞—Ä:" : "Produkt:"}</div><div><strong>${escapeHtml(row.artikel || "-")}</strong></div>
        <div class="label">${lang === "ru" ? "–¶–µ–Ω–∞:" : "Preis:"}</div><div>${escapeHtml(priceText)}</div>
        <div class="label">EAN:</div><div class="mono">${escapeHtml(row.ean || "-")}</div>
      </div>
    `;

    if (playSound) { successSound(); vibrate([30]); }
  }

  function setNotFound(playSound = true) {
    $("resultBox").classList.remove("ok");
    $("resultBox").classList.add("bad");
    $("statusEmoji").textContent = "‚ùå";
    $("resultText").innerHTML = `
      <div><strong>Produkt nicht gefunden</strong></div>
      <div><strong>–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω</strong></div>
    `;
    lastFound = null;
    $("btnSendOffice").disabled = true;
    $("sizeSelect").disabled = true;

    if (playSound) { errorSound(); vibrate([60, 30, 60]); }
  }

  function lookup(query, playSound = true) {
    const q = String(query ?? "").trim();
    if (!q) { setNotFound(false); return; }

    const qDigits = digitsOnly(q);
    if (qDigits.length >= 6) {
      const hit = indexByEAN.get(qDigits);
      if (hit) return setFound(hit, playSound);
      const hit2 = rows.find(r => r.ean && r.ean.includes(qDigits));
      if (hit2) return setFound(hit2, playSound);
      return setNotFound(playSound);
    }

    const qLower = q.toLowerCase();
    const hit = rows.find(r => (r.artikel || "").toLowerCase().includes(qLower));
    if (hit) return setFound(hit, playSound);

    return setNotFound(playSound);
  }

  /** -------- CSV Load -------- */
  $("csvFile").addEventListener("change", (ev) => {
    const file = ev.target.files?.[0];
    if (!file) { setNotLoaded(); return; }

    setNotLoaded();
    $("resultText").textContent = t("loadingCsv");

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: (res) => {
        const raw = res.data || [];
        const normalized = raw.map(normalizeRow).filter(r => r.artikel || r.ean);

        rows = normalized;
        indexByEAN = new Map();
        for (const r of rows) if (r.ean) indexByEAN.set(r.ean, r);

        $("searchInput").disabled = false;
        $("btnScan").disabled = false;

        $("resultBox").classList.remove("ok", "bad");
        $("statusEmoji").textContent = "‚úÖ";
        $("resultText").textContent = t("loadedCsv", rows.length);
        $("dbStatus").textContent = t("db", rows.length);

        $("sizeSelect").disabled = false;
        $("btnSendOffice").disabled = true;
        lastFound = null;

        // small confirmation sound
        beep(520, 70, "sine", 0.05);
      },
      error: () => {
        $("resultBox").classList.add("bad");
        $("statusEmoji").textContent = "‚ùå";
        $("resultText").textContent = (lang === "ru") ? "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è CSV." : "CSV konnte nicht gelesen werden.";
        errorSound();
      }
    });
  });

  $("searchInput").addEventListener("input", (ev) => lookup(ev.target.value, true));

  /** -------- Scanner -------- */
  async function startScan() {
    if (scanning || !rows.length) return;

    // wake up audio context on user gesture
    await ensureAudio();

    $("videoWrap").style.display = "block";
    $("btnScan").disabled = true;
    $("btnStop").disabled = false;
    $("searchInput").disabled = true;

    scanning = true;
    scanner = new ZXingBrowser.BrowserMultiFormatReader();

    try {
      const videoEl = $("video");
      const constraints = { audio: false, video: { facingMode: { ideal: "environment" } } };

      await scanner.decodeFromConstraints(constraints, videoEl, (result, err, controls) => {
        if (!scanner._controls) scanner._controls = controls;
        if (result) {
          const text = result.getText ? result.getText() : String(result.text || "");
          const ean = digitsOnly(text);
          if (ean) {
            $("searchInput").value = ean;
            // playSound true because scan is a deliberate action
            lookup(ean, true);
            stopScan();
          }
        }
      });
    } catch (e) {
      $("resultBox").classList.add("bad");
      $("statusEmoji").textContent = "‚ùå";
      $("resultText").innerHTML = `
        <div><strong>${lang === "ru" ? "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É." : "Kamera konnte nicht gestartet werden."}</strong></div>
        <div class="hint">${lang === "ru" ? "–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS." : "Bitte Kamera-Berechtigung erlauben und HTTPS nutzen."}</div>
      `;
      errorSound();
      stopScan(true);
    }
  }

  function stopScan(keepUI = false) {
    try { if (scanner?._controls) scanner._controls.stop(); } catch {}
    try { scanner?.reset?.(); } catch {}
    scanner = null;
    scanning = false;

    if (!keepUI) $("videoWrap").style.display = "none";
    $("btnScan").disabled = !rows.length;
    $("btnStop").disabled = true;
    $("searchInput").disabled = !rows.length;
  }

  $("btnScan").addEventListener("click", startScan);
  $("btnStop").addEventListener("click", () => stopScan(false));

  /** -------- Send to Office -------- */
  async function sendToOffice() {
    // user gesture -> resume audio if needed
    await ensureAudio();

    if (!lastFound || !lastFound.ean) {
      alert(t("noFound"));
      errorSound();
      return;
    }
    const size = $("sizeSelect").value;

    try {
      const payload = { action: "add", ean: lastFound.ean, size: size, note: "" };

      const res = await fetch(WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => null);
      if (data && data.ok) {
        alert(t("sentOk"));
        sendSound();
        vibrate([20]);
      } else {
        alert(t("sentFail"));
        errorSound();
      }
    } catch (e) {
      alert(t("sentFail"));
      errorSound();
    }
  }

  $("btnSendOffice").addEventListener("click", sendToOffice);

  /** -------- Language -------- */
  $("langSelect").value = lang;
  $("langSelect").addEventListener("change", (ev) => {
    lang = ev.target.value;
    localStorage.setItem("lang", lang);
    applyLang();
    // re-render found product in the new language (without extra sound)
    if (lastFound) setFound(lastFound, false);
  });

  applyLang();
  setNotLoaded();
})();
</script>
</body>
</html>
