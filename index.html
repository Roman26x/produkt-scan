<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Produkt-Scan</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/zxing-browser.min.js"></script>

  <style>
    /* ‚úÖ verhindert "√ºber Rand raus" √ºberall */
    *, *::before, *::after { box-sizing: border-box; }

    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background: #f6f7f8; color: #111; }

    .card {
      max-width: 820px;
      margin: 0 auto;
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
      overflow: hidden;
    }

    .topbar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    h1 { font-size: 18px; margin: 0; }

    .right {
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      max-width:100%;
    }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px; }

    input[type="file"], input[type="text"], input[type="password"], select {
      width:100%;
      padding:12px;
      border:1px solid #ddd;
      border-radius:10px;
      background:#fff;
    }

    button { padding:12px 14px; border:0; border-radius:10px; background:#111; color:#fff; cursor:pointer; }
    button.secondary { background:#444; }
    button:disabled { opacity:.5; cursor:not-allowed; }

    .hint { font-size:12px; color:#666; margin-top:6px; }
    .result { margin-top:14px; padding:14px; border-radius:12px; border:1px solid #e6e6e6; background:#fafafa; }
    .status { font-size:34px; line-height:1; margin-bottom:10px; }
    .ok { border-color:#bfe8c9; background:#f0fbf3; }
    .bad { border-color:#f0b8b8; background:#fff1f1; }

    .kv { display:grid; grid-template-columns:120px 1fr; gap:6px 10px; font-size:14px; }
    .label { color:#555; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .videoWrap { margin-top:12px; display:none; }
    video { width:100%; border-radius:12px; background:#000; }

    .pill {
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:#f0f0f0;
      border:1px solid #e5e5e5;
      max-width:100%;
      white-space:nowrap;
    }

    .toggle { display:flex; align-items:center; gap:8px; }
    .divider{height:1px;background:#eee;margin:14px 0;}
    .hidden{display:none;}

    /* ===== LOGIN (stabil, kein overflow) ===== */
    .login-container { width:100%; max-width:460px; margin:0 auto 14px auto; padding:0 8px; }
    .login-card {
      width:100%;
      background:white;
      border-radius:12px;
      padding:26px;
      border:1px solid #e2e8f0;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.10);
      overflow:hidden;
    }
    .login-header { text-align:center; margin-bottom:18px; }
    .login-header h2 { font-size:1.6rem; font-weight:800; color:#1e293b; margin:0 0 6px 0; }
    .login-header p { color:#64748b; font-size:0.9rem; margin:0; }

    .form-group { margin-bottom:16px; }
    .input-wrapper { position:relative; display:block; width:100%; }

    .login-card .input-wrapper input {
      width:100%;
      max-width:100%;
      background:#fff;
      border:2px solid #e2e8f0;
      border-radius:8px;
      padding:20px 16px 10px 16px;
      color:#1e293b;
      font-size:16px;
      transition:all .2s ease;
      outline:none;
    }
    .login-card .input-wrapper input::placeholder { color:transparent; }

    .login-card .input-wrapper label {
      position:absolute;
      left:16px;
      top:14px;
      color:#64748b;
      font-size:14px;
      transition:all .2s ease;
      pointer-events:none;
      transform-origin:left top;
    }

    .login-card .input-wrapper input:focus,
    .login-card .input-wrapper input:valid,
    .login-card .input-wrapper input.has-value {
      border-color:#6366f1;
    }
    .login-card .input-wrapper input:focus + label,
    .login-card .input-wrapper input:valid + label,
    .login-card .input-wrapper input.has-value + label {
      transform:translateY(-8px) scale(.90);
      color:#6366f1;
      font-weight:700;
    }

    .password-wrapper { position:relative; }
    .password-wrapper input { padding-right:56px !important; }

    .password-toggle {
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      background:none;
      border:none;
      cursor:pointer;
      padding:8px;
      color:#64748b;
    }

    .eye-icon {
      display:block;
      width:20px;
      height:20px;
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b' stroke-width='1.5'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z'/%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z'/%3e%3c/svg%3e");
    }
    .eye-icon.show-password {
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b' stroke-width='1.5'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 11-4.243-4.243m4.242 4.242L9.88 9.88'/%3e%3c/svg%3e");
    }

    .error-message {
      display:block;
      color:#ef4444;
      font-size:.78rem;
      font-weight:600;
      margin-top:6px;
      margin-left:4px;
      opacity:0;
      transform:translateY(-4px);
      transition:all .2s ease;
      min-height:1em;
    }
    .error-message.show { opacity:1; transform:translateY(0); }

    .login-btn {
      width:100%;
      max-width:100%;
      background:#6366f1;
      border:none;
      border-radius:8px;
      padding:12px 24px;
      color:white;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      transition:all .2s ease;
      position:relative;
    }
    .login-btn:hover { background:#4f46e5; }
    .login-btn:active { transform:translateY(1px); }
    .login-btn.loading { pointer-events:none; background:#a5a6f6; }
    .btn-text { transition:opacity .2s ease; }
    .btn-loader {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      width:16px;
      height:16px;
      border:2px solid transparent;
      border-top:2px solid white;
      border-radius:50%;
      opacity:0;
      animation:spin 1s linear infinite;
      transition:opacity .2s ease;
    }
    .login-btn.loading .btn-text { opacity:0; }
    .login-btn.loading .btn-loader { opacity:1; }

    @keyframes spin {
      0% { transform:translate(-50%, -50%) rotate(0deg); }
      100% { transform:translate(-50%, -50%) rotate(360deg); }
    }

    @media (max-width:520px){
      body { padding:10px; }
      .pill { white-space:normal; }
      #langSelect { min-width:120px !important; }
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="topbar">
      <h1 id="title">Produkt-Suche</h1>
      <div class="right">
        <span class="pill" id="userPill">‚Äî</span>
        <span class="pill" id="dbStatus">DB: ‚Äì</span>

        <label class="pill toggle" title="Sound an/aus">
          <input type="checkbox" id="soundToggle" checked />
          <span>üîä</span>
        </label>

        <select id="langSelect" style="width:auto; min-width:140px;">
          <option value="de">Deutsch</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        </select>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginBox" class="login-container">
      <div class="login-card">
        <div class="login-header">
          <h2 id="loginH2">Anmelden</h2>
          <p id="loginP">Benutzername und PIN eingeben</p>
        </div>

        <form id="loginForm" novalidate>
          <div class="form-group">
            <div class="input-wrapper">
              <input type="text" id="loginUser" required autocomplete="username">
              <label for="loginUser" id="loginUserLabel">Benutzername</label>
            </div>
            <span class="error-message" id="userError"></span>
          </div>

          <div class="form-group">
            <div class="input-wrapper password-wrapper">
              <input type="password" id="loginPin" required inputmode="numeric" autocomplete="current-password">
              <label for="loginPin" id="loginPinLabel">PIN</label>
              <button type="button" class="password-toggle" id="pinToggle" aria-label="Toggle PIN visibility">
                <span class="eye-icon" id="eyeIcon"></span>
              </button>
            </div>
            <span class="error-message" id="pinError"></span>
          </div>

          <button type="submit" class="login-btn" id="btnLogin">
            <span class="btn-text" id="btnLoginText">Einloggen</span>
            <span class="btn-loader"></span>
          </button>
        </form>
      </div>
      <div class="divider"></div>
    </div>

    <!-- APP -->
    <div id="appBox" class="hidden">
      <div class="row">
        <div style="flex: 1 1 360px;">
          <input id="csvFile" type="file" accept=".csv,text/csv" />
          <div class="hint" id="csvHint">CSV muss Spalten haben: Artikel, VK-Preis, EAN</div>
        </div>
      </div>

      <div class="row">
        <div style="flex: 1 1 360px;">
          <input id="searchInput" type="text" placeholder="Suchen nach Produktname oder EAN ‚Ä¶" disabled />
          <div class="hint" id="searchHint">Tipp: Du kannst auch nur einen Teil tippen.</div>
        </div>

        <button id="btnScan" disabled>üì∑ EAN scannen</button>
        <button id="btnStop" class="secondary" disabled>‚èπ Stop</button>
        <button id="btnLogout" class="secondary">Logout</button>
      </div>

      <div class="row">
        <div style="flex: 1 1 260px;">
          <select id="sizeSelect" disabled>
            <option value="80x39" data-de="Regaletikett" data-ru="–ü–æ–ª–æ—á–Ω–∞—è —ç—Ç–∏–∫–µ—Ç–∫–∞">Regaletikett</option>
            <option value="50x25" data-de="Kleinetikett" data-ru="–ú–∞–ª–µ–Ω—å–∫–∞—è —ç—Ç–∏–∫–µ—Ç–∫–∞">Kleinetikett</option>
            <option value="35x70" data-de="K√ºhlwaren Etikett" data-ru="–≠—Ç–∏–∫–µ—Ç–∫–∞ –¥–ª—è —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞">K√ºhlwaren Etikett</option>
          </select>
          <div class="hint" id="sizeHint">Etikettart w√§hlen</div>
        </div>

        <button id="btnSendOffice" disabled>üè∑Ô∏è Etikett ans B√ºro senden</button>
      </div>

      <div class="videoWrap" id="videoWrap">
        <div class="hint" id="scanHint">Kamera l√§uft ‚Äì halte den Barcode ruhig ins Bild.</div>
        <video id="video" playsinline></video>
        <div class="hint" id="scanTip">Wenn es nicht scannt: mehr Licht, n√§her ran, ruhiger halten.</div>
      </div>

      <div class="result" id="resultBox">
        <div class="status" id="statusEmoji">üîí</div>
        <div id="resultText" class="hint">Bitte zuerst einloggen.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ‚úÖ DEINE WEBAPP URL
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzKFVuk3W6sNGPvSVqOsXxwqfzOGq8H36nx5aA2B_JaHtLQzpoKwcgfr53-BiTFL35B/exec";

  const I18N = {
    de: {
      title:"Produkt-Suche",
      loginH2:"Anmelden",
      loginP:"Benutzername und PIN eingeben",
      userLabel:"Benutzername",
      pinLabel:"PIN",
      loginBtn:"Einloggen",
      badUser:"Bitte Benutzername eingeben.",
      badPin:"PIN mindestens 4 Ziffern.",
      badCred:"Falscher Benutzername oder PIN.",
      netFail:"Netzwerkfehler / falsche WebApp URL.",
      csvHint:"CSV muss Spalten haben: Artikel, VK-Preis, EAN",
      searchPh:"Suchen nach Produktname oder EAN ‚Ä¶",
      searchHint:"Tipp: Du kannst auch nur einen Teil tippen.",
      scanBtn:"üì∑ EAN scannen",
      stopBtn:"‚èπ Stop",
      logoutBtn:"Logout",
      sizeHint:"Etikettart w√§hlen",
      sendBtn:"üè∑Ô∏è Etikett ans B√ºro senden",
      scanHint:"Kamera l√§uft ‚Äì halte den Barcode ruhig ins Bild.",
      scanTip:"Wenn es nicht scannt: mehr Licht, n√§her ran, ruhiger halten.",
      loadingCsv:"CSV wird geladen ‚Ä¶",
      loadedCsv:(n)=>`CSV geladen: ${n} Zeilen. Jetzt suchen oder scannen.`,
      notLoaded:"Bitte CSV laden ‚Ä¶",
      sentOk:"Gesendet ‚úÖ",
      sentFail:"Fehler beim Senden ‚ùå",
      noFound:"Kein Produkt gefunden.",
      db:(n)=>`DB: ${n}`,
      needLogin:"Bitte zuerst einloggen.",
      notAllowed:"Dein Account darf hier nicht senden."
    },
    ru: {
      title:"–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞",
      loginH2:"–í—Ö–æ–¥",
      loginP:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ PIN",
      userLabel:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
      pinLabel:"PIN",
      loginBtn:"–í–æ–π—Ç–∏",
      badUser:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
      badPin:"PIN –º–∏–Ω–∏–º—É–º 4 —Ü–∏—Ñ—Ä—ã.",
      badCred:"–ù–µ–≤–µ—Ä–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ PIN.",
      netFail:"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ / –Ω–µ–≤–µ—Ä–Ω–∞—è WebApp URL.",
      csvHint:"CSV –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –∫–æ–ª–æ–Ω–∫–∏: Artikel, VK-Preis, EAN",
      searchPh:"–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ EAN ‚Ä¶",
      searchHint:"–°–æ–≤–µ—Ç: –º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —á–∞—Å—Ç—å —Å–ª–æ–≤–∞.",
      scanBtn:"üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å EAN",
      stopBtn:"‚èπ –°—Ç–æ–ø",
      logoutBtn:"–í—ã–π—Ç–∏",
      sizeHint:"–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —ç—Ç–∏–∫–µ—Ç–∫–∏",
      sendBtn:"üè∑Ô∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ—Ñ–∏—Å",
      scanHint:"–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞ ‚Äî –¥–µ—Ä–∂–∏—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Ä–æ–≤–Ω–æ.",
      scanTip:"–ï—Å–ª–∏ –Ω–µ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç: –±–æ–ª—å—à–µ —Å–≤–µ—Ç–∞, –±–ª–∏–∂–µ, —Ä–æ–≤–Ω–µ–µ.",
      loadingCsv:"–ó–∞–≥—Ä—É–∑–∫–∞ CSV ‚Ä¶",
      loadedCsv:(n)=>`CSV –∑–∞–≥—Ä—É–∂–µ–Ω: —Å—Ç—Ä–æ–∫ ${n}. –ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –∏–ª–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å.`,
      notLoaded:"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ CSV ‚Ä¶",
      sentOk:"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ",
      sentFail:"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ‚ùå",
      noFound:"–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.",
      db:(n)=>`–ë–î: ${n}`,
      needLogin:"–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ.",
      notAllowed:"–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å."
    }
  };

  const $ = (id)=>document.getElementById(id);
  const digitsOnly = (s)=>String(s??"").replace(/\D/g,"");

  // ===== Sound =====
  let audioCtx=null;
  function soundEnabled(){ return $("soundToggle")?.checked; }
  async function ensureAudio(){
    if(!soundEnabled()) return null;
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state==="suspended"){ try{ await audioCtx.resume(); } catch {} }
    return audioCtx;
  }
  function beep(freq=880,ms=120,type="sine",gainVal=0.08){
    if(!soundEnabled()) return;
    ensureAudio().then((ctx)=>{
      if(!ctx) return;
      const t0=ctx.currentTime;
      const osc=ctx.createOscillator(); osc.type=type; osc.frequency.setValueAtTime(freq,t0);
      const gain=ctx.createGain();
      gain.gain.setValueAtTime(0.0001,t0);
      gain.gain.exponentialRampToValueAtTime(gainVal,t0+0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001,t0+ms/1000);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t0); osc.stop(t0+ms/1000+0.02);
    });
  }
  function successSound(){ beep(880,110,"sine",0.09); setTimeout(()=>beep(1320,90,"sine",0.07),120); }
  function errorSound(){ beep(220,160,"square",0.06); setTimeout(()=>beep(180,160,"square",0.05),170); }
  function sendSound(){ beep(660,90,"triangle",0.07); setTimeout(()=>beep(990,70,"triangle",0.06),100); }

  $("soundToggle").checked = (localStorage.getItem("sound") ?? "1") === "1";
  $("soundToggle").addEventListener("change", ()=>{
    localStorage.setItem("sound", $("soundToggle").checked ? "1" : "0");
    if($("soundToggle").checked) ensureAudio();
  });

  // ===== Lang =====
  let lang = localStorage.getItem("lang") || "de";
  function t(key,arg){
    const d=I18N[lang]||I18N.de;
    const v=d[key];
    return (typeof v==="function") ? v(arg) : v;
  }
  function applySizeLabels(){
    const sel=$("sizeSelect");
    for(const opt of sel.querySelectorAll("option")){
      const de=opt.getAttribute("data-de")||opt.textContent;
      const ru=opt.getAttribute("data-ru")||opt.textContent;
      opt.textContent = (lang==="ru") ? ru : de;
    }
  }
  function applyLang(){
    $("title").textContent=t("title");
    $("loginH2").textContent=t("loginH2");
    $("loginP").textContent=t("loginP");
    $("loginUserLabel").textContent=t("userLabel");
    $("loginPinLabel").textContent=t("pinLabel");
    $("btnLoginText").textContent=t("loginBtn");

    $("csvHint").textContent=t("csvHint");
    $("searchInput").placeholder=t("searchPh");
    $("searchHint").textContent=t("searchHint");
    $("btnScan").textContent=t("scanBtn");
    $("btnStop").textContent=t("stopBtn");
    $("btnLogout").textContent=t("logoutBtn");
    $("sizeHint").textContent=t("sizeHint");
    $("btnSendOffice").textContent=t("sendBtn");
    $("scanHint").textContent=t("scanHint");
    $("scanTip").textContent=t("scanTip");

    $("dbStatus").textContent=t("db", rows.length || "‚Äì");
    applySizeLabels();
  }

  $("langSelect").value=lang;
  $("langSelect").addEventListener("change",(ev)=>{
    lang=ev.target.value;
    localStorage.setItem("lang", lang);
    applyLang();
    if(lastFound) setFound(lastFound,false);
  });

  // ===== Float labels =====
  function bindFloatLabel(inputId){
    const inp = $(inputId);
    if(!inp) return;
    const update = ()=>{
      if(inp.value && inp.value.trim().length>0) inp.classList.add("has-value");
      else inp.classList.remove("has-value");
    };
    inp.addEventListener("input", update);
    inp.addEventListener("blur", update);
    setTimeout(update, 0);
    setTimeout(update, 150);
  }
  bindFloatLabel("loginUser");
  bindFloatLabel("loginPin");

  // ===== PIN toggle =====
  $("pinToggle").addEventListener("click", ()=>{
    const inp = $("loginPin");
    const icon = $("eyeIcon");
    const isPwd = inp.type === "password";
    inp.type = isPwd ? "text" : "password";
    icon.classList.toggle("show-password", isPwd);
  });

  // ===== State =====
  let token = localStorage.getItem("token_staff") || "";
  let userRole = localStorage.getItem("role_staff") || "";
  let username = localStorage.getItem("user_staff") || "";

  let rows = [];
  let indexByEAN = new Map();
  let lastFound = null;

  let scanner = null;
  let scanning = false;

  function setLoginUI(loggedIn){
    $("loginBox").classList.toggle("hidden", loggedIn);
    $("appBox").classList.toggle("hidden", !loggedIn);
    $("userPill").textContent = loggedIn ? `${username} (${userRole})` : "‚Äî";
    if(!loggedIn){
      $("statusEmoji").textContent="üîí";
      $("resultText").textContent=t("needLogin");
    }
  }

  // ===== API helper (robust) =====
  async function apiPost(payload){
    const res = await fetch(WEBAPP_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function tryActions(actionNames, payloadBuilder){
    let lastErr = null;
    for(const action of actionNames){
      try{
        const payload = payloadBuilder(action);
        const data = await apiPost(payload);
        if(data && (data.ok === true || data.success === true)) return data;
        // manche APIs liefern ok=false + error
        lastErr = data?.error || data?.message || JSON.stringify(data);
      }catch(e){
        lastErr = String(e);
      }
    }
    throw new Error(lastErr || "unknown_error");
  }

  function showError(elId, msg){
    const el = $(elId);
    if(!el) return;
    el.textContent = msg || "";
    el.classList.toggle("show", !!msg);
  }

  function setLoadingLogin(on){
    $("btnLogin").classList.toggle("loading", !!on);
  }

  function canSend(role){ return (role === "admin" || role === "staff"); }

  // ===== Login =====
  async function login(){
    await ensureAudio();
    showError("userError","");
    showError("pinError","");

    const u=String($("loginUser").value||"").trim();
    const p=digitsOnly($("loginPin").value||"");

    if(!u){ showError("userError", t("badUser")); errorSound(); return; }
    if(p.length<4){ showError("pinError", t("badPin")); errorSound(); return; }

    setLoadingLogin(true);
    try{
      // ‚úÖ probiert mehrere action-namen + mehrere feldnamen
      const data = await tryActions(
        ["auth_login","login","auth","user_login","pin_login"],
        (action)=>({
          action,
          username: u,
          user: u,
          login: u,
          pin: p,
          password: p
        })
      );

      // ‚úÖ token & user/role robust lesen
      const tok = data.token || data.session || data.sessionToken || data.authToken || "";
      const usrObj = data.user || data.account || {};
      const role = (usrObj.role || data.role || data.userRole || "staff");
      const uname = (usrObj.username || usrObj.name || data.username || u);

      if(!tok){
        // server sagte ok, aber token fehlt -> trotzdem reinlassen, aber senden deaktivieren
        token = "NO_TOKEN";
      } else {
        token = tok;
      }
      username = uname;
      userRole = role;

      localStorage.setItem("token_staff", token);
      localStorage.setItem("user_staff", username);
      localStorage.setItem("role_staff", userRole);

      successSound();
      setLoginUI(true);
      setNotLoaded(); // zeigt "Bitte CSV laden"
      return;

    }catch(e){
      showError("pinError", t("badCred"));
      // wenn es eher nach URL/Netzwerk aussieht
      const msg = String(e||"");
      if(msg.includes("Failed to fetch") || msg.includes("NetworkError")) showError("pinError", t("netFail"));
      errorSound();
    }finally{
      setLoadingLogin(false);
    }
  }

  $("loginForm").addEventListener("submit",(e)=>{ e.preventDefault(); login(); });

  function logout(){
    token=""; username=""; userRole="";
    localStorage.removeItem("token_staff");
    localStorage.removeItem("user_staff");
    localStorage.removeItem("role_staff");

    rows=[]; indexByEAN=new Map(); lastFound=null;
    $("csvFile").value="";
    $("searchInput").value="";
    $("searchInput").disabled=true;
    $("btnScan").disabled=true;
    $("btnStop").disabled=true;
    $("btnSendOffice").disabled=true;
    $("sizeSelect").disabled=true;

    stopScan(true);
    setLoginUI(false);
  }
  $("btnLogout").addEventListener("click", logout);

  // ===== CSV & Suche =====
  function normalizeRow(r){
    const artikel=(r["Artikel"]??r["artikel"]??r["Product"]??r["Produkt"]??"").toString().trim();
    const preis=(r["VK-Preis"]??r["VK Preis"]??r["Preis"]??r["price"]??"").toString().trim();
    const eanRaw=(r["EAN"]??r["ean"]??r["Barcode"]??"").toString().trim();
    const ean=digitsOnly(eanRaw);
    return {artikel, preis, ean};
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g,(m)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
  }

  function setNotLoaded(){
    $("resultBox").classList.remove("ok","bad");
    $("statusEmoji").textContent = token ? "üì¶" : "üîí";
    $("resultText").textContent = token ? t("notLoaded") : t("needLogin");
    lastFound=null;
    $("btnSendOffice").disabled=true;
    $("sizeSelect").disabled=true;
  }

  function setFound(row, playSound=true){
    $("resultBox").classList.remove("bad");
    $("resultBox").classList.add("ok");
    $("statusEmoji").textContent="‚úÖ";

    lastFound=row;
    $("btnSendOffice").disabled=false;
    $("sizeSelect").disabled=false;

    const priceText=row.preis?row.preis:"-";
    $("resultText").innerHTML = `
      <div class="kv">
        <div class="label">${lang==="ru"?"–¢–æ–≤–∞—Ä:":"Produkt:"}</div><div><strong>${escapeHtml(row.artikel||"-")}</strong></div>
        <div class="label">${lang==="ru"?"–¶–µ–Ω–∞:":"Preis:"}</div><div>${escapeHtml(priceText)}</div>
        <div class="label">EAN:</div><div class="mono">${escapeHtml(row.ean||"-")}</div>
      </div>
    `;
    if(playSound) successSound();
  }

  function setNotFound(playSound=true){
    $("resultBox").classList.remove("ok");
    $("resultBox").classList.add("bad");
    $("statusEmoji").textContent="‚ùå";
    $("resultText").innerHTML = `<div><strong>Produkt nicht gefunden</strong></div><div><strong>–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω</strong></div>`;
    lastFound=null;
    $("btnSendOffice").disabled=true;
    $("sizeSelect").disabled=true;
    if(playSound) errorSound();
  }

  function lookup(q, playSound=true){
    const s=String(q||"").trim();
    if(!s){ setNotFound(false); return; }
    const d=digitsOnly(s);

    if(d.length>=6){
      const hit=indexByEAN.get(d);
      if(hit) return setFound(hit, playSound);
      const hit2 = rows.find(r=>r.ean && r.ean.includes(d));
      if(hit2) return setFound(hit2, playSound);
      return setNotFound(playSound);
    }

    const ql=s.toLowerCase();
    const hit=rows.find(r=>(r.artikel||"").toLowerCase().includes(ql));
    if(hit) return setFound(hit, playSound);
    return setNotFound(playSound);
  }

  $("csvFile").addEventListener("change",(ev)=>{
    if(!token){ alert(t("needLogin")); return; }
    const file=ev.target.files?.[0];
    if(!file){ setNotLoaded(); return; }

    setNotLoaded();
    $("resultText").textContent = t("loadingCsv");

    Papa.parse(file,{
      header:true, skipEmptyLines:true,
      complete:(res)=>{
        const raw=res.data||[];
        rows = raw.map(normalizeRow).filter(r=>r.artikel || r.ean);

        indexByEAN=new Map();
        for(const r of rows) if(r.ean) indexByEAN.set(r.ean, r);

        $("searchInput").disabled=false;
        $("btnScan").disabled=false;
        $("sizeSelect").disabled=false;

        $("resultBox").classList.remove("ok","bad");
        $("statusEmoji").textContent="‚úÖ";
        $("resultText").textContent = t("loadedCsv", rows.length);
        $("dbStatus").textContent = t("db", rows.length);
      },
      error:()=>{
        $("resultBox").classList.add("bad");
        $("statusEmoji").textContent="‚ùå";
        $("resultText").textContent = (lang==="ru")?"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è CSV.":"CSV konnte nicht gelesen werden.";
        errorSound();
      }
    });
  });

  $("searchInput").addEventListener("input",(ev)=>lookup(ev.target.value,true));

  // ===== Scan =====
  async function startScan(){
    if(!token){ alert(t("needLogin")); return; }
    if(scanning || !rows.length) return;
    await ensureAudio();

    $("videoWrap").style.display="block";
    $("btnScan").disabled=true;
    $("btnStop").disabled=false;
    $("searchInput").disabled=true;

    scanning=true;
    scanner=new ZXingBrowser.BrowserMultiFormatReader();

    try{
      const videoEl=$("video");
      const constraints={audio:false, video:{facingMode:{ideal:"environment"}}};

      await scanner.decodeFromConstraints(constraints, videoEl, (result)=>{
        if(result){
          const text = result.getText ? result.getText() : String(result.text || "");
          const ean = digitsOnly(text);
          if(ean){
            $("searchInput").value = ean;
            lookup(ean, true);
            stopScan();
          }
        }
      });
    }catch(e){
      $("resultBox").classList.add("bad");
      $("statusEmoji").textContent="‚ùå";
      $("resultText").innerHTML = `<div><strong>${lang==="ru"?"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É.":"Kamera konnte nicht gestartet werden."}</strong></div>`;
      errorSound();
      stopScan(true);
    }
  }

  function stopScan(keepUI=false){
    try{ scanner?.reset?.(); }catch{}
    scanner=null;
    scanning=false;

    if(!keepUI) $("videoWrap").style.display="none";
    $("btnScan").disabled = !rows.length;
    $("btnStop").disabled = true;
    $("searchInput").disabled = !rows.length;
  }

  $("btnScan").addEventListener("click", startScan);
  $("btnStop").addEventListener("click", ()=>stopScan(false));

  // ===== Send to office (robust) =====
  async function sendToOffice(){
    await ensureAudio();

    if(!token){ alert(t("needLogin")); errorSound(); return; }
    if(!canSend(userRole)){ alert(t("notAllowed")); errorSound(); return; }
    if(!lastFound || !lastFound.ean){ alert(t("noFound")); errorSound(); return; }

    const size = $("sizeSelect").value;
    const note = username;

    try{
      await tryActions(
        ["queue_add","add","enqueue","etikett_add","sheet_add"],
        (action)=>({
          action,
          token,
          ean:lastFound.ean,
          barcode:lastFound.ean,
          size,
          labelSize:size,
          note,
          user:username
        })
      );
      alert(t("sentOk"));
      sendSound();
    }catch(e){
      alert(t("sentFail") + "\n" + String(e||""));
      errorSound();
    }
  }

  $("btnSendOffice").addEventListener("click", sendToOffice);

  // ===== Init =====
  applyLang();
  if(token){
    setLoginUI(true);
    setNotLoaded();
    $("searchInput").disabled = true;
    $("btnScan").disabled = true;
    $("btnSendOffice").disabled = true;
    $("sizeSelect").disabled = true;
  }else{
    setLoginUI(false);
  }
})();
</script>
</body>
</html>

