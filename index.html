<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>EAN Scanner</title>

  <!-- ‚úÖ ZXing UMD (Fallback f√ºr iPhone Safari, wenn BarcodeDetector fehlt) -->
  <!-- Wichtig: @zxing/browser (nicht @zxing/library) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>

  <!-- ‚úÖ PapaParse f√ºr CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    *,*::before,*::after{box-sizing:border-box}
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:#f6f7f8;color:#111;padding:16px}
    .card{max-width:980px;margin:0 auto;background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#f0f0f0;border:1px solid #e5e5e5;white-space:nowrap}
    select,input,button{font:inherit}
    button{padding:10px 12px;border:0;border-radius:10px;background:#111;color:#fff;cursor:pointer}
    button.secondary{background:#444}
    button.ok{background:#15803d}
    button:disabled{opacity:.5;cursor:not-allowed}
    input[type="text"],input[type="file"],select{
      width:100%;
      padding:12px;
      border:1px solid #ddd;
      border-radius:10px;
      background:#fff;
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{border:1px solid #eee;border-radius:12px;padding:12px;background:#fafafa}
    .panel h2{margin:0 0 8px 0;font-size:14px}
    .hint{font-size:12px;color:#666;margin-top:6px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    .row .auto{flex:0 0 auto}
    .divider{height:1px;background:#eee;margin:14px 0}
    .result{padding:14px;border-radius:12px;border:1px solid #e5e5e5;background:#fff}
    .status{font-size:44px;line-height:1}
    .result h3{margin:8px 0 4px 0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    video{
      width:100%;
      border-radius:12px;
      background:#000;
      border:1px solid #e5e5e5;
      max-height:340px;
      object-fit:cover;
    }
    .hidden{display:none}
    .small{font-size:12px;color:#666}
    .okline{color:#15803d;font-weight:700}
    .badline{color:#b91c1c;font-weight:800}
  </style>
</head>

<body>
  <div class="card">
    <div class="topbar">
      <h1 id="title">EAN Scanner</h1>
      <div class="right">
        <label class="pill" title="Sound an/aus" style="display:flex;gap:8px;align-items:center;cursor:pointer;">
          <input type="checkbox" id="soundToggle" checked />
          <span>üîä</span>
        </label>

        <select id="langSelect" style="width:auto;min-width:140px;">
          <option value="de">Deutsch</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        </select>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h2 id="dbTitle">Datenbank (CSV)</h2>
        <input id="csvFile" type="file" accept=".csv,text/csv" />
        <div class="hint" id="dbHint">CSV muss mindestens Spalten enthalten: <b>Artikel</b>, <b>VK-Preis</b>, <b>EAN</b></div>
        <div class="divider"></div>

        <div class="row">
          <input id="searchInput" type="text" placeholder="Produktname oder EAN suchen‚Ä¶" />
          <button id="btnSearch" class="auto">üîé</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="btnScan">üì∑ Scannen</button>
          <button id="btnStop" class="secondary" disabled>‚èπ Stop</button>

          <select id="sizeSelect">
            <option value="80x39">Regaletikett</option>
            <option value="35x70">K√ºhlwaren Etikett</option>
            <option value="50x25">Kleinetikett</option>
          </select>

          <button id="btnSend" class="ok" disabled>üè∑Ô∏è Etikett ans B√ºro senden</button>
        </div>

        <div class="hint" id="scanHint"></div>
      </div>

      <div class="panel">
        <h2 id="resTitle">Ergebnis</h2>
        <div class="result" id="resultBox">
          <div class="status" id="statusIcon">‚Äî</div>
          <h3 id="resName">‚Äî</h3>
          <div id="resPrice" class="mono"></div>
          <div id="resEAN" class="mono"></div>
          <div id="resMsg" class="hint"></div>
        </div>

        <div class="divider"></div>

        <div id="scanBox" class="hidden">
          <video id="video" playsinline></video>
          <div class="small" id="cameraNote"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ‚úÖ DEINE Google Apps Script WebApp URL (Queue / Users / Auth)
  // Wenn du f√ºr index.html keine Queue nutzt, kannst du btnSend einfach ignorieren.
  const WEBAPP_URL = ""; // <- optional: hier deine URL rein, wenn Senden aktiv sein soll

  const $ = (id) => document.getElementById(id);

  // ===== i18n =====
  const I18N = {
    de: {
      title: "EAN Scanner",
      dbTitle: "Datenbank (CSV)",
      dbHint: "CSV muss mindestens Spalten enthalten: Artikel, VK-Preis, EAN",
      resTitle: "Ergebnis",
      phSearch: "Produktname oder EAN suchen‚Ä¶",
      scanHintReady: "Kamera bereit. Halte den Barcode ruhig ins Bild.",
      scanHintNeedHttps: "Kamera geht nur √ºber HTTPS (GitHub Pages ist OK).",
      scanHintNoCam: "Keine Kamera verf√ºgbar oder Zugriff verweigert.",
      scanHintZXingMissing: "ZXing konnte nicht geladen werden (Internet/Adblock?).",
      found: "Gefunden ‚úÖ",
      notFound: "Produkt nicht gefunden",
      notFoundRu: "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω",
      sendOk: "Gesendet ‚úÖ",
      sendFail: "Fehler beim Senden",
      pickDb: "Bitte zuerst eine CSV laden.",
      pickRow: "Scanne zuerst oder suche zuerst (damit ein Produkt ausgew√§hlt ist).",
      sizeName: (v) => {
        if (v==="80x39") return "Regaletikett";
        if (v==="35x70") return "K√ºhlwaren Etikett";
        if (v==="50x25") return "Kleinetikett";
        return v || "-";
      }
    },
    ru: {
      title: "–°–∫–∞–Ω–µ—Ä EAN",
      dbTitle: "–ë–∞–∑–∞ (CSV)",
      dbHint: "CSV –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç–æ–ª–±—Ü—ã: Artikel, VK-Preis, EAN",
      resTitle: "–†–µ–∑—É–ª—å—Ç–∞—Ç",
      phSearch: "–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ EAN‚Ä¶",
      scanHintReady: "–ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞. –î–µ—Ä–∂–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥ —Ä–æ–≤–Ω–æ –≤ –∫–∞–¥—Ä–µ.",
      scanHintNeedHttps: "–ö–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ HTTPS.",
      scanHintNoCam: "–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.",
      scanHintZXingMissing: "ZXing –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç/–±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫?).",
      found: "–ù–∞–π–¥–µ–Ω–æ ‚úÖ",
      notFound: "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω",
      notFoundRu: "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω",
      sendOk: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ",
      sendFail: "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏",
      pickDb: "–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ CSV.",
      pickRow: "–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ/–æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä.",
      sizeName: (v) => {
        if (v==="80x39") return "–ü–æ–ª–æ—á–Ω–∞—è —ç—Ç–∏–∫–µ—Ç–∫–∞";
        if (v==="35x70") return "–≠—Ç–∏–∫–µ—Ç–∫–∞ –¥–ª—è —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞";
        if (v==="50x25") return "–ú–∞–ª–µ–Ω—å–∫–∞—è —ç—Ç–∏–∫–µ—Ç–∫–∞";
        return v || "-";
      }
    }
  };

  let lang = localStorage.getItem("lang") || "de";
  $("langSelect").value = lang;

  function t(key, arg){
    const d = I18N[lang] || I18N.de;
    const v = d[key];
    return (typeof v === "function") ? v(arg) : v;
  }

  function applyLang(){
    $("title").textContent = t("title");
    $("dbTitle").textContent = t("dbTitle");
    $("dbHint").innerHTML = t("dbHint");
    $("resTitle").textContent = t("resTitle");
    $("searchInput").placeholder = t("phSearch");
  }

  $("langSelect").addEventListener("change", (e) => {
    lang = e.target.value;
    localStorage.setItem("lang", lang);
    applyLang();
    // Ergebnistext neu zeichnen (wenn vorhanden)
    if (lastQuery) doSearch(lastQuery, "lang");
  });

  applyLang();

  // ===== sound =====
  let audioCtx = null;
  function soundEnabled(){ return $("soundToggle").checked; }
  async function ensureAudio(){
    if(!soundEnabled()) return null;
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === "suspended"){ try{ await audioCtx.resume(); }catch{} }
    return audioCtx;
  }
  function beep(freq=880, ms=120, type="sine", gainVal=0.08){
    if(!soundEnabled()) return;
    ensureAudio().then((ctx)=>{
      if(!ctx) return;
      const t0 = ctx.currentTime;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, t0);
      gain.gain.setValueAtTime(0.0001, t0);
      gain.gain.exponentialRampToValueAtTime(gainVal, t0+0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, t0+(ms/1000));
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t0); osc.stop(t0+(ms/1000)+0.02);
    });
  }
  function okSound(){ beep(880,110,"sine",0.08); setTimeout(()=>beep(1320,90,"sine",0.06),120); }
  function badSound(){ beep(220,160,"square",0.06); setTimeout(()=>beep(180,160,"square",0.05),170); }

  $("soundToggle").checked = (localStorage.getItem("sound") ?? "1") === "1";
  $("soundToggle").addEventListener("change", ()=>{
    localStorage.setItem("sound", $("soundToggle").checked ? "1" : "0");
    if($("soundToggle").checked) ensureAudio();
  });

  // ===== helpers =====
  const digitsOnly = (s) => String(s ?? "").replace(/\D/g, "");

  function ean13CheckDigit(d12){
    // d12 = 12 digits
    let sum = 0;
    for(let i=0;i<12;i++){
      const n = parseInt(d12[i],10);
      sum += (i%2===0) ? n : (3*n);
    }
    return (10 - (sum % 10)) % 10;
  }

  function normalizeEanCandidates(raw){
    const d = digitsOnly(raw);
    const out = new Set();
    if(!d) return out;

    // add raw digits as-is
    out.add(d);

    // 12 -> compute 13
    if(d.length === 12){
      out.add(d + String(ean13CheckDigit(d)));
    }

    // 13 -> also allow base 12
    if(d.length === 13){
      out.add(d.slice(0,12));
    }

    // Some scanners may return leading zeros weirdly; try trimmed/ padded variants:
    // (Nur leicht ‚Äì wir zerst√∂ren keine echte EAN, wir f√ºgen nur Alternativen hinzu)
    if(d.length > 8){
      out.add(d.replace(/^0+/, "")); // without leading zeros
    }

    return out;
  }

  // ===== CSV DB =====
  let dbRows = [];
  let eanMap = new Map(); // normalizedEan -> row
  let lastFoundRow = null;
  let lastQuery = "";

  function buildEanMap(rows){
    eanMap = new Map();
    for(const r of rows){
      const eanRaw = r["EAN"] ?? r["ean"] ?? r["Barcode"] ?? r["barcode"] ?? "";
      const cands = normalizeEanCandidates(eanRaw);
      for(const c of cands){
        if(!c) continue;
        if(!eanMap.has(c)){
          eanMap.set(c, r);
        }
      }
    }
  }

  function parseCsv(file){
    return new Promise((resolve, reject) => {
      if(!window.Papa) return reject(new Error("PapaParse fehlt"));
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,   // ‚úÖ extrem wichtig: EAN nicht als Zahl interpretieren
        transformHeader: (h) => String(h||"").trim(),
        transform: (v) => (typeof v === "string" ? v.trim() : v),
        complete: (res) => resolve(res.data || []),
        error: (err) => reject(err)
      });
    });
  }

  function setResult(found, row, queryEan){
    const status = $("statusIcon");
    const name = $("resName");
    const price = $("resPrice");
    const ean = $("resEAN");
    const msg = $("resMsg");

    if(found && row){
      status.textContent = "‚úÖ";
      name.textContent = row["Artikel"] ?? row["artikel"] ?? "‚Äî";
      price.textContent = "Preis: " + String(row["VK-Preis"] ?? row["VK-Preis "] ?? row["Preis"] ?? row["price"] ?? "").trim();
      ean.textContent = "EAN: " + (digitsOnly(row["EAN"] ?? queryEan ?? "") || "‚Äî");
      msg.innerHTML = `<span class="okline">${t("found")}</span>`;
      lastFoundRow = row;
      $("btnSend").disabled = !WEBAPP_URL; // nur aktiv, wenn URL gesetzt
      okSound();
    }else{
      status.textContent = "‚ùå";
      name.textContent = "‚Äî";
      price.textContent = "";
      ean.textContent = queryEan ? ("EAN: " + digitsOnly(queryEan)) : "";
      msg.innerHTML = `<span class="badline">${t("notFound")}</span><br>${t("notFoundRu")}`;
      lastFoundRow = null;
      $("btnSend").disabled = true;
      badSound();
    }
  }

  function findInDb(query){
    const q = String(query||"").trim();
    if(!q) return null;

    // 1) try EAN map
    const cands = normalizeEanCandidates(q);
    for(const c of cands){
      if(eanMap.has(c)) return eanMap.get(c);
    }

    // 2) name contains
    const ql = q.toLowerCase();
    for(const r of dbRows){
      const name = String(r["Artikel"] ?? r["artikel"] ?? "").toLowerCase();
      if(name && name.includes(ql)) return r;
    }
    return null;
  }

  async function loadDbFromFile(file){
    $("scanHint").textContent = "";
    try{
      const rows = await parseCsv(file);

      // very basic required columns check
      // (wir lassen es auch zu, wenn Header minimal anders sind, aber Artikel/VK-Preis/EAN sollten existieren)
      const sample = rows[0] || {};
      const headers = Object.keys(sample);
      const hasArtikel = headers.some(h => h.toLowerCase() === "artikel");
      const hasPreis   = headers.some(h => h.toLowerCase().replace(/\s/g,"") === "vk-preis" || h.toLowerCase().includes("preis"));
      const hasEan     = headers.some(h => h.toLowerCase() === "ean" || h.toLowerCase() === "barcode");

      if(!hasArtikel || !hasPreis || !hasEan){
        $("scanHint").textContent = "‚ö†Ô∏è CSV-Spalten pr√ºfen. Erwartet: Artikel, VK-Preis, EAN.";
      }

      dbRows = rows;
      buildEanMap(dbRows);

      $("scanHint").textContent = `‚úÖ CSV geladen: ${dbRows.length} Zeilen.`;
      okSound();
    }catch(e){
      $("scanHint").textContent = "CSV-Fehler: " + String(e);
      badSound();
    }
  }

  $("csvFile").addEventListener("change", (e) => {
    const f = e.target.files?.[0];
    if(f) loadDbFromFile(f);
  });

  // ===== search =====
  function doSearch(query, source=""){
    lastQuery = String(query||"").trim();
    if(!dbRows.length){
      $("scanHint").textContent = t("pickDb");
      badSound();
      return;
    }
    const row = findInDb(lastQuery);
    const maybeEan = digitsOnly(lastQuery);
    setResult(!!row, row, maybeEan || lastQuery);
  }

  $("btnSearch").addEventListener("click", () => doSearch($("searchInput").value, "btn"));
  $("searchInput").addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      doSearch($("searchInput").value, "enter");
    }
  });

  // ===== camera / scanning =====
  let scanning = false;
  let stream = null;
  let zxingReader = null;
  let barcodeDetector = null;

  async function stopCamera(silent=false){
    scanning = false;

    try{
      if(zxingReader && zxingReader.reset) zxingReader.reset();
    }catch{}

    try{
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
      }
    }catch{}
    stream = null;

    $("btnScan").disabled = false;
    $("btnStop").disabled = true;
    $("scanBox").classList.add("hidden");
    if(!silent) $("scanHint").textContent = "";
  }

    async function hardStopStreamsOnly(){
    // stop decoding
    try{ if(zxingReader && zxingReader.reset) zxingReader.reset(); }catch{}
    zxingReader = null;

    // stop camera tracks
    try{
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
      }
    }catch{}
    stream = null;

    // detach video
    const v = $("video");
    try{ v.pause(); }catch{}
    v.srcObject = null;
  }


  async function startCamera(){
    await ensureAudio();
    if(!dbRows.length){
      $("scanHint").textContent = t("pickDb");
      badSound();
      return;
    }

    // HTTPS check (camera needs https or localhost)
    const isSecure = (location.protocol === "https:" || location.hostname === "localhost");
    if(!isSecure){
      $("scanHint").textContent = t("scanHintNeedHttps");
      badSound();
      return;
    }

    $("scanBox").classList.remove("hidden");
    $("btnScan").disabled = true;
    $("btnStop").disabled = false;

    const video = $("video");
    video.setAttribute("playsinline", "");
    video.muted = true;
    video.autoplay = true;

    // 1) BarcodeDetector if available (Chrome/Android mostly)
    if("BarcodeDetector" in window){
      try{
        barcodeDetector = new BarcodeDetector({ formats: ["ean_13","ean_8","code_128","upc_a","upc_e","qr_code"] });
      }catch{
        barcodeDetector = null;
      }
    }

    // getUserMedia (environment camera)
    try{
            // ‚úÖ Vor jedem Start: alte Streams wirklich schlie√üen
      await hardStopStreamsOnly();

      // iPhone/Safari: erst "simple constraints" versuchen
      const constraintsSimple = { video: { facingMode: { ideal: "environment" } }, audio: false };

      const constraintsIdeal  = { video: { facingMode: { ideal: "environment" } }, audio: false };

      async function openCamOnce(constraints){
        const s = await navigator.mediaDevices.getUserMedia(constraints);
        const video = $("video");
        video.setAttribute("playsinline", "");
        video.muted = true;
        video.autoplay = true;
        video.srcObject = s;

        // warten bis video ready (Safari)
        await new Promise((resolve, reject)=>{
          const t = setTimeout(()=>reject(new Error("video_timeout")), 5000);
          video.onloadedmetadata = ()=>{ clearTimeout(t); resolve(); };
        });

        await video.play();
        return s;
      }

      try{
        stream = await openCamOnce(constraintsSimple);
      }catch(e1){
        // AbortError ‚Üí einmal kurz warten und nochmal probieren
        if(String(e1?.name || e1).includes("AbortError")){
          await new Promise(r=>setTimeout(r, 300));
          try{
            stream = await openCamOnce(constraintsSimple);
          }catch(e2){
            // fallback auf ideal
            stream = await openCamOnce(constraintsIdeal);
          }
        }else{
          // fallback auf ideal
          stream = await openCamOnce(constraintsIdeal);
        }
      }

    }catch(e){
      $("scanHint").textContent = t("scanHintNoCam") + " (" + String(e) + ")";
      badSound();
      await hardStopStreamsOnly();
      return;
    }

    scanning = true;
    $("scanHint").textContent = t("scanHintReady");
    $("cameraNote").textContent = "Tipp: iPhone ‚Üí Kamera-Zugriff in Safari erlauben & nicht im privaten Modus.";

    // 1) BarcodeDetector loop
    if(barcodeDetector){
      const tick = async () => {
        if(!scanning) return;
        try{
          const codes = await barcodeDetector.detect(video);
          if(codes && codes.length){
            const raw = codes[0].rawValue || "";
            const d = digitsOnly(raw);
            if(d.length >= 8){
              $("searchInput").value = d;
              doSearch(d, "scan");
              // kleiner cooldown, sonst mehrfaches Triggern
              setTimeout(()=>{ if(scanning) requestAnimationFrame(tick); }, 650);
              return;
            }
          }
        }catch{}
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
      return;
    }

    // 2) ZXing fallback (iPhone Safari)
    // UMD global can be ZXingBrowser (recommended). We handle both.
    const ZX = window.ZXingBrowser || window.ZXing;
    if(!ZX){
      $("scanHint").textContent = t("scanHintZXingMissing");
      badSound();
      await stopCamera(true);
      return;
    }

    // Create reader
    try{
      zxingReader = new ZX.BrowserMultiFormatReader();
    }catch(e){
      $("scanHint").textContent = "ZXing init error: " + String(e);
      badSound();
      await stopCamera(true);
      return;
    }

    // Choose a deviceId (prefer back camera if possible)
    let deviceId = undefined;
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === "videoinput");
      // prefer "back"/"rear"/"environment" keywords
      const preferred = cams.find(d => /back|rear|environment/i.test(d.label));
      deviceId = (preferred || cams[0])?.deviceId;
    }catch{
      deviceId = undefined;
    }

    try{
      // decodeFromVideoDevice attaches to the <video> element by id
      await zxingReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
        if(!scanning) return;
        if(result){
          const text = (result.getText ? result.getText() : String(result)) || "";
          const d = digitsOnly(text);
          if(d.length >= 8){
            $("searchInput").value = d;
            doSearch(d, "scan");
            // ZXing feuert gern schnell mehrfach ‚Üí kurze Pause
            scanning = false;
            setTimeout(()=>{ scanning = true; }, 650);
          }
        }
      });
    }catch(e){
      $("scanHint").textContent = "Kamera-Fehler: " + String(e);
      badSound();
      await stopCamera(true);
    }
  }

  $("btnScan").addEventListener("click", startCamera);
  $("btnStop").addEventListener("click", ()=>stopCamera(false));

  // ===== Send to Office (Queue) =====
  async function apiPost(payload){
    const res = await fetch(WEBAPP_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  $("btnSend").addEventListener("click", async ()=>{
    if(!WEBAPP_URL){
      $("scanHint").textContent = "WEBAPP_URL ist leer.";
      badSound();
      return;
    }
    if(!lastFoundRow){
      $("scanHint").textContent = t("pickRow");
      badSound();
      return;
    }
    const size = $("sizeSelect").value;
    const ean = digitsOnly(lastFoundRow["EAN"] ?? $("searchInput").value ?? "");
    if(!ean){
      $("scanHint").textContent = "EAN fehlt.";
      badSound();
      return;
    }

    $("btnSend").disabled = true;
    try{
      const data = await apiPost({
        action: "queue_add",
        ean,
        size,
        note: "Scan"
      });
      if(data && (data.ok === true || data.success === true)){
        $("scanHint").textContent = t("sendOk") + " (" + t("sizeName", size) + ")";
        okSound();
      }else{
        $("scanHint").textContent = t("sendFail") + ": " + (data?.error || data?.message || "unknown");
        badSound();
      }
    }catch(e){
      $("scanHint").textContent = t("sendFail") + ": " + String(e);
      badSound();
    }finally{
      $("btnSend").disabled = false;
    }
  });

  // init
  setResult(false, null, "");
})();
</script>
</body>
</html>
