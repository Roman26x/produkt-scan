<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Produkt-Suche</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; padding:16px; background:#f6f7f8; color:#111; }

    .card{
      max-width: 980px;
      margin: 0 auto;
      background:#fff;
      border-radius:14px;
      padding:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap;
    }
    h1{ margin:0; font-size:18px; }

    .right{
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:#f0f0f0; border:1px solid #e5e5e5;
      max-width:100%; white-space:nowrap;
    }
    .toggle{ display:flex; align-items:center; gap:8px; }

    button{
      padding:10px 12px;
      border:0; border-radius:10px;
      background:#111; color:#fff;
      cursor:pointer;
    }
    button.secondary{ background:#444; }
    button.ok{ background:#15803d; }
    button.danger{ background:#b91c1c; }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    input[type="text"], input[type="password"], select{
      width:100%;
      padding:12px;
      border:1px solid #ddd;
      border-radius:10px;
      background:#fff;
    }
    .divider{ height:1px; background:#eee; margin:14px 0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px; }
    .hint{ font-size:12px; color:#666; margin-top:6px; }
    .hidden{ display:none; }

    /* ===== LOGIN (sch√∂nes Form) ===== */
    .loginWrap{ max-width:460px; margin:0 auto; padding:0 8px; }
    .loginCard{
      background:#fff;
      border-radius:12px;
      padding:26px;
      border:1px solid #e2e8f0;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.10);
      overflow:hidden;
    }
    .loginHeader{ text-align:center; margin-bottom:18px; }
    .loginHeader h2{ margin:0 0 6px 0; font-size:1.6rem; font-weight:800; color:#1e293b; }
    .loginHeader p{ margin:0; color:#64748b; font-size:.9rem; }
    .form-group{ margin-bottom:16px; }
    .input-wrapper{ position:relative; width:100%; }
    .input-wrapper input{
      width:100%;
      background:#fff;
      border:2px solid #e2e8f0;
      border-radius:8px;
      padding:20px 16px 10px 16px;
      color:#1e293b;
      font-size:16px;
      outline:none;
      transition:all .2s ease;
    }
    .input-wrapper input::placeholder{ color:transparent; }
    .input-wrapper label{
      position:absolute; left:16px; top:14px;
      color:#64748b; font-size:14px;
      transition:all .2s ease;
      pointer-events:none;
      transform-origin:left top;
    }
    .input-wrapper input:focus,
    .input-wrapper input:valid,
    .input-wrapper input.has-value{ border-color:#6366f1; }
    .input-wrapper input:focus + label,
    .input-wrapper input:valid + label,
    .input-wrapper input.has-value + label{
      transform:translateY(-8px) scale(.90);
      color:#6366f1;
      font-weight:700;
    }
    .error-message{
      display:block; color:#ef4444; font-size:.78rem;
      font-weight:600; margin-top:6px; margin-left:4px;
      opacity:0; transform:translateY(-4px);
      transition:all .2s ease;
      min-height:1em;
      white-space:pre-wrap;
    }
    .error-message.show{ opacity:1; transform:translateY(0); }

    .login-btn{
      width:100%;
      background:#6366f1;
      border:none; border-radius:8px;
      padding:12px 24px;
      color:#fff; font-size:16px;
      font-weight:800; cursor:pointer;
      transition:all .2s ease;
      position:relative;
    }
    .login-btn:hover{ background:#4f46e5; }
    .login-btn.loading{ pointer-events:none; background:#a5a6f6; }
    .btn-text{ transition:opacity .2s ease; }
    .btn-loader{
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:16px; height:16px;
      border:2px solid transparent;
      border-top:2px solid white;
      border-radius:50%;
      opacity:0;
      animation:spin 1s linear infinite;
      transition:opacity .2s ease;
    }
    .login-btn.loading .btn-text{ opacity:0; }
    .login-btn.loading .btn-loader{ opacity:1; }
    @keyframes spin{
      0%{ transform:translate(-50%,-50%) rotate(0deg); }
      100%{ transform:translate(-50%,-50%) rotate(360deg); }
    }

    /* ===== Ergebnis ===== */
    .resultBox{
      border:1px solid #eee;
      border-radius:12px;
      padding:14px;
      background:#fafafa;
    }
    .bigIcon{ font-size:34px; line-height:1; }
    .resultTitle{ font-weight:900; font-size:18px; margin:8px 0 6px; }
    .kv{ display:grid; grid-template-columns: 120px 1fr; gap:6px 10px; }
    .kv div{ font-size:14px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    video{
      width:100%;
      max-height:340px;
      background:#000;
      border-radius:12px;
      border:1px solid #ddd;
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="topbar">
      <h1 id="title">Produkt-Suche</h1>
      <div class="right">
        <span class="pill" id="userPill">‚Äî</span>

        <label class="pill toggle" title="Sound an/aus">
          <input type="checkbox" id="soundToggle" checked />
          <span>üîä</span>
        </label>

        <select id="langSelect" style="width:auto; min-width:140px;">
          <option value="de">Deutsch</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        </select>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginBox" class="loginWrap" style="margin-top:12px;">
      <div class="loginCard">
        <div class="loginHeader">
          <h2 id="loginH2">Anmelden</h2>
          <p id="loginP">Benutzername und PIN eingeben</p>
        </div>

        <form id="loginForm" novalidate>
          <div class="form-group">
            <div class="input-wrapper">
              <input type="text" id="loginUser" required autocomplete="username">
              <label for="loginUser" id="loginUserLabel">Benutzername</label>
            </div>
            <span class="error-message" id="userError"></span>
          </div>

          <div class="form-group">
            <div class="input-wrapper">
              <input type="password" id="loginPin" required inputmode="numeric" autocomplete="current-password">
              <label for="loginPin" id="loginPinLabel">PIN</label>
            </div>
            <span class="error-message" id="pinError"></span>
          </div>

          <button type="submit" class="login-btn" id="btnLogin">
            <span class="btn-text" id="btnLoginText">Einloggen</span>
            <span class="btn-loader"></span>
          </button>
          <div class="hint" id="loginHint">Staff/Admin darf diese Seite benutzen.</div>
        </form>
      </div>
    </div>

    <!-- APP -->
    <div id="appBox" class="hidden">
      <div class="divider"></div>

      <div class="row">
        <div style="flex:1 1 260px;">
          <label class="hint" id="csvLabel">CSV Datenbank laden</label>
          <input type="file" id="csvFile" accept=".csv,text/csv" />
          <div class="hint" id="dbHint">DB: ‚Äî</div>
        </div>

        <div style="flex:1 1 220px;">
          <label class="hint" id="sizeLabel">Etikettgr√∂√üe</label>
          <select id="sizeSelect">
            <option value="80x39">Regaletikett</option>
            <option value="35x70">K√ºhlwaren Etikett</option>
            <option value="50x25">Kleinetikett</option>
          </select>
        </div>

        <div style="flex:1 1 260px;">
          <label class="hint" id="searchLabel">Suche (Name oder EAN)</label>
          <input type="text" id="searchInput" placeholder="z.B. Milch oder 401234..." />
          <div class="hint" id="searchHint"></div>
        </div>

        <div class="row" style="flex:1 1 100%; margin-top:2px;">
          <button id="btnScan" class="secondary">üì∑ Scan starten</button>
          <button id="btnStop" class="secondary" disabled>‚èπ Stop</button>
          <button id="btnLogout" class="secondary">Logout</button>
        </div>
      </div>

      <div class="divider"></div>

      <div id="scanBox" class="hidden">
        <video id="video" playsinline></video>
        <div class="hint" id="scanHint">Halte den Barcode in die Kamera.</div>
        <div class="row">
          <input type="text" id="manualEan" placeholder="EAN manuell eingeben" style="flex:1 1 240px;" />
          <button id="btnManual" class="secondary">üîé Suchen</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="resultBox" id="resultBox">
        <div class="bigIcon" id="resultIcon">‚Äî</div>
        <div class="resultTitle" id="resultTitle">‚Äî</div>
        <div class="kv" id="resultKv"></div>
        <div class="divider"></div>
        <button id="btnSend" class="ok" disabled>üè∑Ô∏è Etikett ans B√ºro senden</button>
        <div class="hint" id="sendHint"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ‚úÖ DEINE Google Apps Script WebApp URL
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzIL-kJInj0Gd7f5qU-7-sRMy0_gqPrL3blYcWawsv33Sch50ziSnKTWQ7am3LBKCo1/exec";

  const $ = (id)=>document.getElementById(id);
  const digitsOnly = (s)=>String(s??"").replace(/\\D/g,"");
  const norm = (s)=>String(s??"").trim();

  // ===== i18n =====
  const I18N = {
    de: {
      title:"Produkt-Suche",
      loginH2:"Anmelden",
      loginP:"Benutzername und PIN eingeben",
      userLabel:"Benutzername",
      pinLabel:"PIN",
      loginBtn:"Einloggen",
      loginHint:"Staff/Admin darf diese Seite benutzen.",
      badUser:"Bitte Benutzername eingeben.",
      badPin:"PIN mindestens 4 Ziffern.",
      badCred:"Falscher Benutzername oder PIN.",
      noAccess:"Kein Zugriff (nur staff/admin).",
      needsActive:"Dein Account ist deaktiviert. In Accounts muss active=1 sein.",

      csvLabel:"CSV Datenbank laden",
      dbHint:(n)=>`DB: ${n}`,
      searchLabel:"Suche (Name oder EAN)",
      searchPh:"z.B. Milch oder 401234...",
      scanHint:"Halte den Barcode in die Kamera.",
      manualPh:"EAN manuell eingeben",
      foundTitle:"‚úÖ Produkt gefunden",
      notFoundTitle:"‚ùå Produkt nicht gefunden",
      notFoundRu:"–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω",
      name:"Name",
      price:"Preis",
      ean:"EAN",
      sendBtn:"üè∑Ô∏è Etikett ans B√ºro senden",
      sendOk:"‚úÖ Gesendet!",
      sendFail:(e)=>"Fehler beim senden: " + e,
      needDb:"Bitte erst CSV laden.",
      needProduct:"Bitte erst ein Produkt finden.",
      sizeLabel:"Etikettgr√∂√üe",
      sizeName:(v)=>{
        if(v==="80x39") return "Regaletikett";
        if(v==="35x70") return "K√ºhlwaren Etikett";
        if(v==="50x25") return "Kleinetikett";
        return v || "-";
      }
    },
    ru: {
      title:"–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞",
      loginH2:"–í—Ö–æ–¥",
      loginP:"–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ PIN",
      userLabel:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
      pinLabel:"PIN",
      loginBtn:"–í–æ–π—Ç–∏",
      loginHint:"–≠—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å staff/admin.",
      badUser:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
      badPin:"PIN –º–∏–Ω–∏–º—É–º 4 —Ü–∏—Ñ—Ä—ã.",
      badCred:"–ù–µ–≤–µ—Ä–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ PIN.",
      noAccess:"–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ (—Ç–æ–ª—å–∫–æ staff/admin).",
      needsActive:"–ê–∫–∫–∞—É–Ω—Ç –æ—Ç–∫–ª—é—á—ë–Ω. –í Accounts –Ω—É–∂–Ω–æ active=1.",

      csvLabel:"–ó–∞–≥—Ä—É–∑–∏—Ç—å CSV –±–∞–∑—É",
      dbHint:(n)=>`–ë–î: ${n}`,
      searchLabel:"–ü–æ–∏—Å–∫ (–∏–º—è –∏–ª–∏ EAN)",
      searchPh:"–Ω–∞–ø—Ä–∏–º–µ—Ä: –º–æ–ª–æ–∫–æ –∏–ª–∏ 401234...",
      scanHint:"–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥.",
      manualPh:"–í–≤–µ–¥–∏—Ç–µ EAN –≤—Ä—É—á–Ω—É—é",
      foundTitle:"‚úÖ –¢–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω",
      notFoundTitle:"‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω",
      notFoundRu:"–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω",
      name:"–ù–∞–∑–≤–∞–Ω–∏–µ",
      price:"–¶–µ–Ω–∞",
      ean:"EAN",
      sendBtn:"üè∑Ô∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–∏–∫–µ—Ç–∫—É –≤ –æ—Ñ–∏—Å",
      sendOk:"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!",
      sendFail:(e)=>"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e,
      needDb:"–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ CSV.",
      needProduct:"–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä.",
      sizeLabel:"–†–∞–∑–º–µ—Ä —ç—Ç–∏–∫–µ—Ç–∫–∏",
      sizeName:(v)=>{
        if(v==="80x39") return "–ü–æ–ª–æ—á–Ω–∞—è —ç—Ç–∏–∫–µ—Ç–∫–∞";
        if(v==="35x70") return "–≠—Ç–∏–∫–µ—Ç–∫–∞ –¥–ª—è —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞";
        if(v==="50x25") return "–ú–∞–ª–µ–Ω—å–∫–∞—è —ç—Ç–∏–∫–µ—Ç–∫–∞";
        return v || "-";
      }
    }
  };

  let lang = localStorage.getItem("lang") || "de";
  function t(key,arg){
    const d=I18N[lang]||I18N.de;
    const v=d[key];
    return (typeof v==="function") ? v(arg) : v;
  }
  function applyLang(){
    $("title").textContent=t("title");

    $("loginH2").textContent=t("loginH2");
    $("loginP").textContent=t("loginP");
    $("loginUserLabel").textContent=t("userLabel");
    $("loginPinLabel").textContent=t("pinLabel");
    $("btnLoginText").textContent=t("loginBtn");
    $("loginHint").textContent=t("loginHint");

    $("csvLabel").textContent=t("csvLabel");
    $("sizeLabel").textContent=t("sizeLabel");
    $("searchLabel").textContent=t("searchLabel");
    $("searchInput").placeholder=t("searchPh");
    $("scanHint").textContent=t("scanHint");
    $("manualEan").placeholder=t("manualPh");
    $("btnSend").textContent=t("sendBtn");

    updateDbHint();
  }

  $("langSelect").value=lang;
  $("langSelect").addEventListener("change",(e)=>{
    lang=e.target.value;
    localStorage.setItem("lang", lang);
    applyLang();
    // Ergebnis neu rendern
    if(currentFound) renderFound(currentFound);
    else if(currentNotFound) renderNotFound(currentNotFound);
    else clearResult();
  });

  // ===== sound =====
  let audioCtx=null;
  function soundEnabled(){ return $("soundToggle")?.checked; }
  async function ensureAudio(){
    if(!soundEnabled()) return null;
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state==="suspended"){ try{ await audioCtx.resume(); } catch {} }
    return audioCtx;
  }
  function beep(freq=880,ms=120,type="sine",gainVal=0.08){
    if(!soundEnabled()) return;
    ensureAudio().then((ctx)=>{
      if(!ctx) return;
      const t0=ctx.currentTime;
      const osc=ctx.createOscillator(); osc.type=type; osc.frequency.setValueAtTime(freq,t0);
      const gain=ctx.createGain();
      gain.gain.setValueAtTime(0.0001,t0);
      gain.gain.exponentialRampToValueAtTime(gainVal,t0+0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001,t0+ms/1000);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t0); osc.stop(t0+ms/1000+0.02);
    });
  }
  function successSound(){ beep(880,110,"sine",0.08); setTimeout(()=>beep(1320,90,"sine",0.06),120); }
  function errorSound(){ beep(220,160,"square",0.06); setTimeout(()=>beep(180,160,"square",0.05),170); }

  $("soundToggle").checked = (localStorage.getItem("sound") ?? "1") === "1";
  $("soundToggle").addEventListener("change", ()=>{
    localStorage.setItem("sound", $("soundToggle").checked ? "1" : "0");
    if($("soundToggle").checked) ensureAudio();
  });

  // ===== float labels =====
  function bindFloatLabel(inputId){
    const inp=$(inputId);
    const update=()=>{ inp.value?.trim()?inp.classList.add("has-value"):inp.classList.remove("has-value"); };
    inp.addEventListener("input",update); inp.addEventListener("blur",update);
    setTimeout(update,0); setTimeout(update,150);
  }
  bindFloatLabel("loginUser"); bindFloatLabel("loginPin");

  // ===== Auth state =====
  let token = localStorage.getItem("token") || "";
  let username = localStorage.getItem("user") || "";
  let userRole = localStorage.getItem("role") || "";

  function setLoginUI(loggedIn){
    $("loginBox").classList.toggle("hidden", loggedIn);
    $("appBox").classList.toggle("hidden", !loggedIn);
    $("userPill").textContent = loggedIn ? `${username} (${userRole})` : "‚Äî";
  }

  function hasStaffAccess(role){
    role = String(role||"").toLowerCase();
    return role === "staff" || role === "admin";
  }

  async function apiPost(payload){
    const res = await fetch(WEBAPP_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    if(!text.trim().startsWith("{") && !text.trim().startsWith("[")){
      throw new Error("WebApp antwortet nicht als JSON. Anfang: " + text.slice(0,120));
    }
    return JSON.parse(text);
  }

  function showError(elId,msg){
    const el=$(elId);
    el.textContent = msg || "";
    el.classList.toggle("show", !!msg);
  }
  function setLoadingLogin(on){
    $("btnLogin").classList.toggle("loading", !!on);
  }

  async function login(){
    await ensureAudio();
    showError("userError",""); showError("pinError","");

    const u=norm($("loginUser").value);
    const p=digitsOnly($("loginPin").value);

    if(!u){ showError("userError", t("badUser")); errorSound(); return; }
    if(p.length<4){ showError("pinError", t("badPin")); errorSound(); return; }

    setLoadingLogin(true);
    try{
      const data = await apiPost({ action:"auth_login", username:u, pin:p });

      if(!data || !data.ok){
        const err = String(data?.error || "bad_credentials");
        if(err === "inactive") showError("pinError", t("needsActive"));
        else showError("pinError", t("badCred") + "\\n(" + err + ")");
        errorSound();
        return;
      }

      const tok = data.token || "";
      const role = String((data.user && data.user.role) ? data.user.role : (data.role || "staff"));
      const uname = String((data.user && data.user.username) ? data.user.username : (data.username || u));

      if(!hasStaffAccess(role)){
        showError("pinError", t("noAccess"));
        errorSound();
        return;
      }

      token = tok;
      username = uname;
      userRole = role;

      localStorage.setItem("token", token);
      localStorage.setItem("user", username);
      localStorage.setItem("role", userRole);

      successSound();
      setLoginUI(true);
      updateDbHint();
    }catch(e){
      showError("pinError", "Fehler: " + String(e));
      errorSound();
    }finally{
      setLoadingLogin(false);
    }
  }

  $("loginForm").addEventListener("submit",(e)=>{ e.preventDefault(); login(); });

  function logout(){
    token=""; username=""; userRole="";
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    localStorage.removeItem("role");
    setLoginUI(false);
  }
  $("btnLogout").addEventListener("click", logout);

  // ===== CSV DB =====
  let dbRows = [];
  let dbInfo = { name:"‚Äî", count:0, cols:[] };

  function parseCSV(text){
    // Simple robust CSV parser (supports quotes)
    const rows=[];
    let i=0, field="", row=[], inQuotes=false;
    while(i<text.length){
      const c=text[i];
      if(inQuotes){
        if(c === '"'){
          if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
          inQuotes=false; i++; continue;
        }
        field+=c; i++; continue;
      }else{
        if(c === '"'){ inQuotes=true; i++; continue; }
        if(c === ','){ row.push(field); field=""; i++; continue; }
        if(c === '\\n'){ row.push(field); rows.push(row); field=""; row=[]; i++; continue; }
        if(c === '\\r'){ i++; continue; }
        field+=c; i++; continue;
      }
    }
    row.push(field); rows.push(row);
    return rows;
  }

  function guessColumns(header){
    const h = header.map(x=>String(x||"").trim().toLowerCase());
    const find = (...names)=> {
      for(const n of names){
        const idx = h.indexOf(n);
        if(idx>=0) return idx;
      }
      return -1;
    };
    return {
      idxName: find("name","produkt","produktname","artikel","artikelname","bezeichnung"),
      idxEan:  find("ean","barcode","gtin","eancode","ean13"),
      idxPrice:find("price","preis","vk","verkaufspreis","bruttopreis"),
    };
  }

  function updateDbHint(){
    $("dbHint").textContent = t("dbHint", `${dbInfo.name} (${dbInfo.count})`);
  }

  $("csvFile").addEventListener("change", async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const text = await file.text();
    const table = parseCSV(text);
    if(!table.length){ dbRows=[]; dbInfo={name:file.name,count:0,cols:[]}; updateDbHint(); return; }

    const header = table[0];
    const cols = guessColumns(header);
    const data = table.slice(1).filter(r=>r.some(v=>String(v||"").trim()!==""));

    dbRows = data.map(r=>{
      const name = cols.idxName>=0 ? String(r[cols.idxName]||"") : "";
      const ean = cols.idxEan>=0 ? digitsOnly(r[cols.idxEan]) : "";
      const price = cols.idxPrice>=0 ? String(r[cols.idxPrice]||"") : "";
      return { name, ean, price, raw:r };
    });

    dbInfo = { name:file.name, count:dbRows.length, cols:header };
    updateDbHint();
    clearResult();
    $("searchHint").textContent = "";
    successSound();
  });

  // ===== Search / Result =====
  let currentFound = null;
  let currentNotFound = null;

  function clearResult(){
    currentFound=null; currentNotFound=null;
    $("resultIcon").textContent="‚Äî";
    $("resultTitle").textContent="‚Äî";
    $("resultKv").innerHTML="";
    $("btnSend").disabled=true;
    $("sendHint").textContent="";
  }

  function renderFound(item){
    currentFound=item; currentNotFound=null;
    $("resultIcon").textContent="‚úÖ";
    $("resultTitle").textContent=t("foundTitle");
    $("resultKv").innerHTML = `
      <div>${t("name")}</div><div><strong>${escapeHtml(item.name||"-")}</strong></div>
      <div>${t("price")}</div><div><strong>${escapeHtml(item.price||"-")}</strong></div>
      <div>${t("ean")}</div><div class="mono">${escapeHtml(item.ean||"-")}</div>
      <div>${t("sizeLabel")}</div><div><span class="tag">${escapeHtml(t("sizeName", $("sizeSelect").value))}</span></div>
    `;
    $("btnSend").disabled=false;
    $("sendHint").textContent="";
  }

  function renderNotFound(ean){
    currentFound=null; currentNotFound=ean;
    $("resultIcon").textContent="‚ùå";
    $("resultTitle").textContent=t("notFoundTitle");
    $("resultKv").innerHTML = `
      <div>${t("ean")}</div><div class="mono">${escapeHtml(String(ean||""))}</div>
      <div></div><div style="color:#b91c1c;font-weight:800;">${escapeHtml(t("notFoundRu"))}</div>
    `;
    $("btnSend").disabled=true;
    $("sendHint").textContent="";
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g,(m)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
  }

  function findInDb(query){
    if(!dbRows.length) return { type:"no_db" };
    const q = norm(query);
    if(!q) return { type:"empty" };

    const qDigits = digitsOnly(q);
    const isEanQuery = qDigits.length >= 6;

    if(isEanQuery){
      const hit = dbRows.find(r=>r.ean && r.ean === qDigits);
      return hit ? { type:"found", item:hit } : { type:"not_found", ean:qDigits };
    }

    const qLower = q.toLowerCase();
    const hit = dbRows.find(r=>(r.name||"").toLowerCase().includes(qLower));
    if(hit) return { type:"found", item:hit };

    // fallback: try digits search even if short
    if(qDigits){
      const hit2 = dbRows.find(r=>r.ean && r.ean.includes(qDigits));
      if(hit2) return { type:"found", item:hit2 };
    }

    return { type:"not_found", ean:qDigits || q };
  }

  function doSearch(query){
    const res = findInDb(query);
    if(res.type==="no_db"){
      $("searchHint").textContent = t("needDb");
      errorSound();
      return;
    }
    $("searchHint").textContent = "";
    if(res.type==="found"){
      renderFound(res.item);
      successSound();
    }else if(res.type==="not_found"){
      renderNotFound(res.ean);
      errorSound();
    }else{
      clearResult();
    }
  }

  $("searchInput").addEventListener("input", (e)=>{
    const v = e.target.value;
    if(v.trim().length===0){ clearResult(); return; }
    // live search
    doSearch(v);
  });

  $("btnManual").addEventListener("click", ()=>{
    doSearch($("manualEan").value);
  });

  // ===== Send to Office (Queue) =====
  $("btnSend").addEventListener("click", async ()=>{
    await ensureAudio();

    if(!dbRows.length){
      $("sendHint").textContent = t("needDb");
      errorSound();
      return;
    }
    if(!currentFound || !currentFound.ean){
      $("sendHint").textContent = t("needProduct");
      errorSound();
      return;
    }

    $("btnSend").disabled=true;
    $("sendHint").textContent="‚Ä¶";

    try{
      const size = $("sizeSelect").value; // "80x39" etc.
      const payload = {
        action:"queue_add",
        token,
        ean: String(currentFound.ean),
        size: String(size),
        note: String(username || "staff")
      };
      const data = await apiPost(payload);
      if(!data || !data.ok) throw new Error(data?.error || "send_failed");

      $("sendHint").textContent = t("sendOk");
      successSound();
    }catch(e){
      $("sendHint").textContent = t("sendFail", String(e));
      errorSound();
    }finally{
      setTimeout(()=>{ $("btnSend").disabled = !(currentFound && currentFound.ean); }, 600);
    }
  });

  // ===== Camera Scan =====
  let stream=null;
  let scanTimer=null;
  let barcodeDetector=null;

  async function startCamera(){
    $("scanBox").classList.remove("hidden");
    $("btnScan").disabled=true;
    $("btnStop").disabled=false;

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });
    $("video").srcObject = stream;
    await $("video").play();

    if("BarcodeDetector" in window){
      try{
        barcodeDetector = new BarcodeDetector({ formats: ["ean_13","ean_8","code_128","upc_a","upc_e"] });
      }catch{
        barcodeDetector = new BarcodeDetector();
      }
    }else{
      barcodeDetector = null;
    }

    if(!barcodeDetector){
      $("scanHint").textContent = "BarcodeDetector nicht verf√ºgbar. Bitte EAN manuell eingeben.";
      return;
    }

    scanTimer = setInterval(async ()=>{
      try{
        const barcodes = await barcodeDetector.detect($("video"));
        if(barcodes && barcodes.length){
          const raw = barcodes[0].rawValue || "";
          const ean = digitsOnly(raw);
          if(ean.length>=8){
            $("manualEan").value = ean;
            doSearch(ean);
          }
        }
      }catch{}
    }, 350);
  }

  function stopCamera(){
    $("btnScan").disabled=false;
    $("btnStop").disabled=true;
    $("scanBox").classList.add("hidden");

    if(scanTimer){ clearInterval(scanTimer); scanTimer=null; }
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream=null;
    }
    $("video").srcObject = null;
  }

  $("btnScan").addEventListener("click", async ()=>{
    try{
      await startCamera();
    }catch(e){
      $("scanHint").textContent = "Kamera-Fehler: " + String(e);
      $("btnScan").disabled=false;
      $("btnStop").disabled=true;
      errorSound();
    }
  });
  $("btnStop").addEventListener("click", stopCamera);

  // ===== Init =====
  applyLang();

  if(token && hasStaffAccess(userRole)){
    setLoginUI(true);
  }else{
    setLoginUI(false);
  }

})();
</script>
</body>
</html>
