<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Office ‚Äì Etikett Queue</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; padding:16px; background:#f6f7f8; color:#111; }

    .card{
      max-width: 1100px;
      margin: 0 auto;
      background:#fff;
      border-radius:14px;
      padding:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
      overflow:hidden;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    h1{ margin:0; font-size:18px; }

    .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:#f0f0f0;
      border:1px solid #e5e5e5;
      max-width:100%;
      white-space:nowrap;
    }

    button{
      padding:10px 12px;
      border:0;
      border-radius:10px;
      background:#111;
      color:#fff;
      cursor:pointer;
    }
    button.secondary{ background:#444; }
    button.danger{ background:#b91c1c; }
    button.ok{ background:#15803d; }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .toggle{ display:flex; align-items:center; gap:8px; }

    .hint{ font-size:12px; color:#666; margin-top:6px; }
    .divider{ height:1px; background:#eee; margin:14px 0; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:12px;
    }

    input[type="text"], input[type="password"], select{
      width:100%;
      padding:12px;
      border:1px solid #ddd;
      border-radius:10px;
      background:#fff;
    }

    .loginWrap{
      max-width: 460px;
      margin: 0 auto;
      padding: 0 8px;
    }
    .loginCard{
      background:#fff;
      border-radius:12px;
      padding:26px;
      border:1px solid #e2e8f0;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.10);
      overflow:hidden;
    }
    .loginHeader{ text-align:center; margin-bottom:18px; }
    .loginHeader h2{ margin:0 0 6px 0; font-size:1.6rem; font-weight:800; color:#1e293b; }
    .loginHeader p{ margin:0; color:#64748b; font-size:.9rem; }

    .form-group{ margin-bottom:16px; }
    .input-wrapper{ position:relative; width:100%; }

    .input-wrapper input{
      width:100%;
      background:#fff;
      border:2px solid #e2e8f0;
      border-radius:8px;
      padding:20px 16px 10px 16px;
      color:#1e293b;
      font-size:16px;
      outline:none;
      transition:all .2s ease;
    }
    .input-wrapper input::placeholder{ color:transparent; }

    .input-wrapper label{
      position:absolute;
      left:16px;
      top:14px;
      color:#64748b;
      font-size:14px;
      transition:all .2s ease;
      pointer-events:none;
      transform-origin:left top;
    }

    .input-wrapper input:focus,
    .input-wrapper input:valid,
    .input-wrapper input.has-value{
      border-color:#6366f1;
    }
    .input-wrapper input:focus + label,
    .input-wrapper input:valid + label,
    .input-wrapper input.has-value + label{
      transform:translateY(-8px) scale(.90);
      color:#6366f1;
      font-weight:700;
    }

    .error-message{
      display:block;
      color:#ef4444;
      font-size:.78rem;
      font-weight:600;
      margin-top:6px;
      margin-left:4px;
      opacity:0;
      transform:translateY(-4px);
      transition:all .2s ease;
      min-height:1em;
    }
    .error-message.show{ opacity:1; transform:translateY(0); }

    .login-btn{
      width:100%;
      background:#6366f1;
      border:none;
      border-radius:8px;
      padding:12px 24px;
      color:white;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      transition:all .2s ease;
      position:relative;
    }
    .login-btn:hover{ background:#4f46e5; }

    .login-btn.loading{ pointer-events:none; background:#a5a6f6; }
    .btn-text{ transition:opacity .2s ease; }
    .btn-loader{
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:16px; height:16px;
      border:2px solid transparent;
      border-top:2px solid white;
      border-radius:50%;
      opacity:0;
      animation:spin 1s linear infinite;
      transition:opacity .2s ease;
    }
    .login-btn.loading .btn-text{ opacity:0; }
    .login-btn.loading .btn-loader{ opacity:1; }

    @keyframes spin{
      0%{ transform:translate(-50%,-50%) rotate(0deg); }
      100%{ transform:translate(-50%,-50%) rotate(360deg); }
    }

    table{
      width:100%;
      border-collapse:collapse;
      border:1px solid #eee;
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:#444;
      background:#f7f7f7;
      border-bottom:1px solid #eee;
      padding:10px;
      white-space:nowrap;
    }
    tbody td{
      padding:10px;
      border-bottom:1px solid #f0f0f0;
      vertical-align:top;
      font-size:14px;
    }
    tbody tr:hover{ background:#fafafa; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .tag{
      display:inline-block;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #e5e5e5;
      background:#f3f3f3;
      white-space:nowrap;
    }
    .tag.new{ background:#ecfdf5; border-color:#bbf7d0; }
    .tag.done{ background:#eff6ff; border-color:#bfdbfe; }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    @media (max-width:720px){
      body{ padding:10px; }
      .pill{ white-space:normal; }
      table{ font-size:13px; }
      thead{ display:none; }
      tbody td{ display:block; border-bottom:none; }
      tbody tr{ border-bottom:1px solid #eee; display:block; padding:8px 0; }
      tbody td[data-label]::before{
        content: attr(data-label) ": ";
        font-weight:700;
        color:#444;
      }
      .actions{ margin-top:8px; }
    }

    .hidden{ display:none; }
  </style>
</head>

<body>
  <div class="card">
    <div class="topbar">
      <h1 id="title">Office ‚Äì Etikett Queue</h1>
      <div class="right">
        <span class="pill" id="userPill">‚Äî</span>
        <span class="pill" id="countPill">0</span>

        <label class="pill toggle" title="Sound an/aus">
          <input type="checkbox" id="soundToggle" checked />
          <span>üîä</span>
        </label>

        <select id="langSelect" style="width:auto; min-width:140px;">
          <option value="de">Deutsch</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        </select>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginBox" class="loginWrap">
      <div class="loginCard">
        <div class="loginHeader">
          <h2 id="loginH2">Anmelden</h2>
          <p id="loginP">Benutzername und PIN eingeben</p>
        </div>

        <form id="loginForm" novalidate>
          <div class="form-group">
            <div class="input-wrapper">
              <input type="text" id="loginUser" required autocomplete="username">
              <label for="loginUser" id="loginUserLabel">Benutzername</label>
            </div>
            <span class="error-message" id="userError"></span>
          </div>

          <div class="form-group">
            <div class="input-wrapper">
              <input type="password" id="loginPin" required inputmode="numeric" autocomplete="current-password">
              <label for="loginPin" id="loginPinLabel">PIN</label>
            </div>
            <span class="error-message" id="pinError"></span>
          </div>

          <button type="submit" class="login-btn" id="btnLogin">
            <span class="btn-text" id="btnLoginText">Einloggen</span>
            <span class="btn-loader"></span>
          </button>
          <div class="hint" id="loginHint">Nur Admin/B√ºro-Accounts d√ºrfen die Liste sehen.</div>
        </form>
      </div>
      <div class="divider"></div>
    </div>

    <!-- APP -->
    <div id="appBox" class="hidden">
      <div class="row">
        <button id="btnRefresh">üîÑ Refresh</button>

        <label class="pill toggle" title="Nur neue anzeigen">
          <input type="checkbox" id="onlyNew" checked />
          <span id="onlyNewLabel">nur NEU</span>
        </label>

        <label class="pill toggle" title="Auto Refresh">
          <input type="checkbox" id="autoRefresh" />
          <span id="autoRefreshLabel">Auto</span>
        </label>

        <select id="autoInterval" style="width:auto; min-width:180px;">
          <option value="5000">5s</option>
          <option value="10000" selected>10s</option>
          <option value="15000">15s</option>
          <option value="30000">30s</option>
          <option value="60000">60s</option>
        </select>

        <button id="btnLogout" class="secondary">Logout</button>
      </div>

      <div class="hint" id="subHint">
        Hier siehst du alle Etiketten-Anfragen vom Handy. Du kannst sie als erledigt markieren oder l√∂schen.
      </div>

      <div class="divider"></div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th id="thTime">Zeit</th>
              <th id="thStatus">Status</th>
              <th id="thEAN">EAN</th>
              <th id="thSize">Etikett</th>
              <th id="thNote">Von</th>
              <th id="thActions">Aktionen</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- rows -->
          </tbody>
        </table>
      </div>

      <div class="hint" id="footHint"></div>
    </div>
  </div>

<script>
(() => {
  // ‚úÖ DEINE Google Apps Script WebApp URL
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzKFVuk3W6sNGPvSVqOsXxwqfzOGq8H36nx5aA2B_JaHtLQzpoKwcgfr53-BiTFL35B/exec";

  const $ = (id)=>document.getElementById(id);
  const digitsOnly = (s)=>String(s??"").replace(/\D/g,"");

  // ===== i18n =====
  const I18N = {
    de: {
      title:"Office ‚Äì Etikett Queue",
      loginH2:"Anmelden",
      loginP:"Benutzername und PIN eingeben",
      userLabel:"Benutzername",
      pinLabel:"PIN",
      loginBtn:"Einloggen",
      loginHint:"Nur Admin/B√ºro-Accounts d√ºrfen die Liste sehen.",
      badUser:"Bitte Benutzername eingeben.",
      badPin:"PIN mindestens 4 Ziffern.",
      badCred:"Falscher Benutzername oder PIN.",
      notAllowed:"Kein Zugriff (nur B√ºro/Admin).",

      refresh:"üîÑ Refresh",
      onlyNew:"nur NEU",
      auto:"Auto",
      logout:"Logout",
      subHint:"Hier siehst du alle Etiketten-Anfragen vom Handy. Du kannst sie als erledigt markieren oder l√∂schen.",

      thTime:"Zeit",
      thStatus:"Status",
      thEAN:"EAN",
      thSize:"Etikett",
      thNote:"Von",
      thActions:"Aktionen",

      btnDone:"‚úÖ Erledigt",
      btnDelete:"üóë L√∂schen",
      empty:"Keine Eintr√§ge.",
      loading:"Lade‚Ä¶",
      count:(n)=>`Eintr√§ge: ${n}`,

      sizeName:(v)=>{
        if(v==="80x39") return "Regaletikett";
        if(v==="35x70") return "K√ºhlwaren Etikett";
        if(v==="50x25") return "Kleinetikett";
        return v || "-";
      },
      statusName:(s)=>{
        s=String(s||"").toUpperCase();
        if(s==="NEW") return "NEU";
        if(s==="DONE") return "ERLEDIGT";
        return s || "-";
      }
    },
    ru: {
      title:"–û—Ñ–∏—Å ‚Äî –æ—á–µ—Ä–µ–¥—å —ç—Ç–∏–∫–µ—Ç–æ–∫",
      loginH2:"–í—Ö–æ–¥",
      loginP:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ PIN",
      userLabel:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
      pinLabel:"PIN",
      loginBtn:"–í–æ–π—Ç–∏",
      loginHint:"–¢–æ–ª—å–∫–æ –æ—Ñ–∏—Å/–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫.",
      badUser:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
      badPin:"PIN –º–∏–Ω–∏–º—É–º 4 —Ü–∏—Ñ—Ä—ã.",
      badCred:"–ù–µ–≤–µ—Ä–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ PIN.",
      notAllowed:"–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ (—Ç–æ–ª—å–∫–æ –æ—Ñ–∏—Å/–∞–¥–º–∏–Ω).",

      refresh:"üîÑ –û–±–Ω–æ–≤–∏—Ç—å",
      onlyNew:"—Ç–æ–ª—å–∫–æ –ù–û–í–´–ï",
      auto:"–ê–≤—Ç–æ",
      logout:"–í—ã–π—Ç–∏",
      subHint:"–ó–¥–µ—Å—å –≤–∏–¥–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–µ—á–∞—Ç—å —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤. –ú–æ–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å.",

      thTime:"–í—Ä–µ–º—è",
      thStatus:"–°—Ç–∞—Ç—É—Å",
      thEAN:"EAN",
      thSize:"–≠—Ç–∏–∫–µ—Ç–∫–∞",
      thNote:"–û—Ç",
      thActions:"–î–µ–π—Å—Ç–≤–∏—è",

      btnDone:"‚úÖ –ì–æ—Ç–æ–≤–æ",
      btnDelete:"üóë –£–¥–∞–ª–∏—Ç—å",
      empty:"–ü—É—Å—Ç–æ.",
      loading:"–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶",
      count:(n)=>`–ó–∞–ø–∏—Å–µ–π: ${n}`,

      sizeName:(v)=>{
        if(v==="80x39") return "–ü–æ–ª–æ—á–Ω–∞—è —ç—Ç–∏–∫–µ—Ç–∫–∞";
        if(v==="35x70") return "–≠—Ç–∏–∫–µ—Ç–∫–∞ –¥–ª—è —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞";
        if(v==="50x25") return "–ú–∞–ª–µ–Ω—å–∫–∞—è —ç—Ç–∏–∫–µ—Ç–∫–∞";
        return v || "-";
      },
      statusName:(s)=>{
        s=String(s||"").toUpperCase();
        if(s==="NEW") return "–ù–û–í–û–ï";
        if(s==="DONE") return "–ì–û–¢–û–í–û";
        return s || "-";
      }
    }
  };

  let lang = localStorage.getItem("lang_office") || localStorage.getItem("lang") || "de";

  function t(key,arg){
    const d=I18N[lang]||I18N.de;
    const v=d[key];
    return (typeof v==="function") ? v(arg) : v;
  }

  function applyLang(){
    $("title").textContent = t("title");
    $("loginH2").textContent = t("loginH2");
    $("loginP").textContent  = t("loginP");
    $("loginUserLabel").textContent = t("userLabel");
    $("loginPinLabel").textContent  = t("pinLabel");
    $("btnLoginText").textContent   = t("loginBtn");
    $("loginHint").textContent      = t("loginHint");

    $("btnRefresh").textContent = t("refresh");
    $("onlyNewLabel").textContent = t("onlyNew");
    $("autoRefreshLabel").textContent = t("auto");
    $("btnLogout").textContent = t("logout");
    $("subHint").textContent = t("subHint");

    $("thTime").textContent = t("thTime");
    $("thStatus").textContent = t("thStatus");
    $("thEAN").textContent = t("thEAN");
    $("thSize").textContent = t("thSize");
    $("thNote").textContent = t("thNote");
    $("thActions").textContent = t("thActions");
  }

  $("langSelect").value = lang;
  $("langSelect").addEventListener("change",(e)=>{
    lang = e.target.value;
    localStorage.setItem("lang_office", lang);
    applyLang();
    renderRows(lastRows);
  });

  // ===== sound =====
  let audioCtx=null;
  function soundEnabled(){ return $("soundToggle")?.checked; }
  async function ensureAudio(){
    if(!soundEnabled()) return null;
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state==="suspended"){ try{ await audioCtx.resume(); } catch {} }
    return audioCtx;
  }
  function beep(freq=880,ms=120,type="sine",gainVal=0.08){
    if(!soundEnabled()) return;
    ensureAudio().then((ctx)=>{
      if(!ctx) return;
      const t0=ctx.currentTime;
      const osc=ctx.createOscillator(); osc.type=type; osc.frequency.setValueAtTime(freq,t0);
      const gain=ctx.createGain();
      gain.gain.setValueAtTime(0.0001,t0);
      gain.gain.exponentialRampToValueAtTime(gainVal,t0+0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001,t0+ms/1000);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t0); osc.stop(t0+ms/1000+0.02);
    });
  }
  function successSound(){ beep(880,110,"sine",0.08); setTimeout(()=>beep(1320,90,"sine",0.06),120); }
  function errorSound(){ beep(220,160,"square",0.06); setTimeout(()=>beep(180,160,"square",0.05),170); }
  function notifySound(){ beep(660,90,"triangle",0.07); setTimeout(()=>beep(990,70,"triangle",0.06),100); }

  $("soundToggle").checked = (localStorage.getItem("sound_office") ?? localStorage.getItem("sound") ?? "1") === "1";
  $("soundToggle").addEventListener("change", ()=>{
    localStorage.setItem("sound_office", $("soundToggle").checked ? "1" : "0");
    if($("soundToggle").checked) ensureAudio();
  });

  // ===== float labels =====
  function bindFloatLabel(inputId){
    const inp = $(inputId);
    if(!inp) return;
    const update = ()=>{
      if(inp.value && inp.value.trim().length>0) inp.classList.add("has-value");
      else inp.classList.remove("has-value");
    };
    inp.addEventListener("input", update);
    inp.addEventListener("blur", update);
    setTimeout(update,0);
    setTimeout(update,150);
  }
  bindFloatLabel("loginUser");
  bindFloatLabel("loginPin");

  // ===== auth state =====
  let token = localStorage.getItem("token_office") || "";
  let username = localStorage.getItem("user_office") || "";
  let userRole = localStorage.getItem("role_office") || "";

  function setLoginUI(on){
    $("loginBox").classList.toggle("hidden", on);
    $("appBox").classList.toggle("hidden", !on);
    $("userPill").textContent = on ? `${username} (${userRole})` : "‚Äî";
  }

  // ===== API helper =====
  async function apiPost(payload){
    const res = await fetch(WEBAPP_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function tryActions(actionNames, payloadBuilder){
    let lastErr=null;
    for(const action of actionNames){
      try{
        const data = await apiPost(payloadBuilder(action));
        if(data && (data.ok===true || data.success===true)) return data;
        lastErr = data?.error || data?.message || JSON.stringify(data);
      }catch(e){
        lastErr = String(e);
      }
    }
    throw new Error(lastErr || "unknown_error");
  }

  function showError(elId, msg){
    const el = $(elId);
    el.textContent = msg || "";
    el.classList.toggle("show", !!msg);
  }
  function setLoadingLogin(on){
    $("btnLogin").classList.toggle("loading", !!on);
  }

  function isOfficeRole(role){
    role = String(role||"").toLowerCase();
    return role === "admin" || role === "office" || role === "boss";
  }

  // ===== login =====
  async function login(){
    await ensureAudio();
    showError("userError","");
    showError("pinError","");

    const u = String($("loginUser").value||"").trim();
    const p = digitsOnly($("loginPin").value||"");

    if(!u){ showError("userError", t("badUser")); errorSound(); return; }
    if(p.length<4){ showError("pinError", t("badPin")); errorSound(); return; }

    setLoadingLogin(true);
    try{
      const data = await tryActions(
        ["auth_login","login","auth","user_login","pin_login"],
        (action)=>({ action, username:u, user:u, login:u, pin:p, password:p })
      );

      const tok = data.token || data.session || data.sessionToken || data.authToken || "";
      const usrObj = data.user || data.account || {};
      const role = (usrObj.role || data.role || data.userRole || "staff");
      const uname = (usrObj.username || usrObj.name || data.username || u);

      if(!isOfficeRole(role)){
        showError("pinError", t("notAllowed"));
        errorSound();
        return;
      }

      token = tok || "NO_TOKEN";
      username = uname;
      userRole = role;

      localStorage.setItem("token_office", token);
      localStorage.setItem("user_office", username);
      localStorage.setItem("role_office", userRole);

      successSound();
      setLoginUI(true);
      await refresh();
    }catch(e){
      showError("pinError", t("badCred"));
      errorSound();
    }finally{
      setLoadingLogin(false);
    }
  }

  $("loginForm").addEventListener("submit",(e)=>{ e.preventDefault(); login(); });

  function logout(){
    token=""; username=""; userRole="";
    localStorage.removeItem("token_office");
    localStorage.removeItem("user_office");
    localStorage.removeItem("role_office");
    stopAuto();
    setLoginUI(false);
  }
  $("btnLogout").addEventListener("click", logout);

  // ===== render =====
  let lastRows = [];
  let lastNewCount = 0;

  function fmtTime(ts){
    if(!ts) return "-";
    const d = new Date(ts);
    if(isNaN(d.getTime())) return String(ts);
    return d.toLocaleString();
  }

  function statusTag(s){
    const up = String(s||"").toUpperCase();
    const cls = up==="NEW" ? "new" : (up==="DONE" ? "done" : "");
    return `<span class="tag ${cls}">${escapeHtml(t("statusName", up))}</span>`;
  }

  function sizeTag(v){
    const name = t("sizeName", v);
    return `<span class="tag">${escapeHtml(name)}</span>`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g,(m)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
  }

  function renderRows(rows){
    lastRows = Array.isArray(rows) ? rows : [];
    const onlyNew = $("onlyNew").checked;

    const filtered = onlyNew
      ? lastRows.filter(r => String(r.status||"").toUpperCase()==="NEW")
      : lastRows;

    $("countPill").textContent = t("count", filtered.length);

    // Notification sound when new items appear
    const newCount = lastRows.filter(r => String(r.status||"").toUpperCase()==="NEW").length;
    if(newCount > lastNewCount && $("autoRefresh").checked){
      notifySound();
    }
    lastNewCount = newCount;

    const tb = $("tbody");
    tb.innerHTML = "";

    if(filtered.length === 0){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 6;
      td.style.padding = "16px";
      td.textContent = t("empty");
      tr.appendChild(td);
      tb.appendChild(tr);
      return;
    }

    for(const r of filtered){
      const id = r.id ?? r.rowId ?? r._id ?? "";
      const ean = r.ean || r.barcode || "";
      const size = r.size || r.labelSize || "";
      const note = r.note || r.user || r.by || "";
      const ts = r.timestamp || r.time || r.created || "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td data-label="${escapeHtml(t("thTime"))}">${escapeHtml(fmtTime(ts))}</td>
        <td data-label="${escapeHtml(t("thStatus"))}">${statusTag(r.status)}</td>
        <td data-label="${escapeHtml(t("thEAN"))}"><span class="mono">${escapeHtml(ean)}</span></td>
        <td data-label="${escapeHtml(t("thSize"))}">${sizeTag(size)}</td>
        <td data-label="${escapeHtml(t("thNote"))}">${escapeHtml(note || "-")}</td>
        <td data-label="${escapeHtml(t("thActions"))}">
          <div class="actions">
            <button class="ok" data-act="done" data-id="${escapeHtml(id)}">${escapeHtml(t("btnDone"))}</button>
            <button class="danger" data-act="del" data-id="${escapeHtml(id)}">${escapeHtml(t("btnDelete"))}</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    }

    tb.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const act = btn.getAttribute("data-act");
        const id  = btn.getAttribute("data-id");
        if(!id) return;

        btn.disabled = true;
        try{
          if(act==="done"){
            await markDone(id);
          }else if(act==="del"){
            await removeRow(id);
          }
          await refresh();
          successSound();
        }catch(e){
          alert(String(e||"Fehler"));
          errorSound();
        }finally{
          btn.disabled = false;
        }
      });
    });
  }

  // ===== queue actions (robust) =====
  async function fetchQueue(){
    const onlyNew = $("onlyNew").checked ? "1" : "0";
    const data = await tryActions(
      ["queue_list","list","get","queue_get","sheet_list"],
      (action)=>({ action, token, onlyNew })
    );
    return data.rows || data.data || data.items || [];
  }

  async function markDone(id){
    await tryActions(
      ["queue_done","done","mark_done","queue_update","sheet_update"],
      (action)=>({ action, token, id, status:"DONE" })
    );
  }

  async function removeRow(id){
    await tryActions(
      ["queue_delete","delete","remove","queue_remove","sheet_delete"],
      (action)=>({ action, token, id })
    );
  }

  // ===== refresh / auto =====
  let autoTimer=null;

  async function refresh(){
    $("footHint").textContent = t("loading");
    try{
      const rows = await fetchQueue();
      renderRows(rows);
      $("footHint").textContent = "";
    }catch(e){
      $("footHint").textContent = "Fehler: " + String(e||"");
    }
  }

  function stopAuto(){
    if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }
  }
  function startAuto(){
    stopAuto();
    const ms = parseInt($("autoInterval").value, 10) || 10000;
    autoTimer = setInterval(refresh, ms);
  }

  $("btnRefresh").addEventListener("click", refresh);

  $("onlyNew").addEventListener("change", ()=>{
    renderRows(lastRows);
  });

  $("autoRefresh").addEventListener("change", ()=>{
    if($("autoRefresh").checked) startAuto();
    else stopAuto();
  });

  $("autoInterval").addEventListener("change", ()=>{
    if($("autoRefresh").checked) startAuto();
  });

  // ===== init =====
  applyLang();

  if(token && isOfficeRole(userRole)){
    setLoginUI(true);
    refresh();
  }else{
    setLoginUI(false);
  }
})();
</script>
</body>
</html>
